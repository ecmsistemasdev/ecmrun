<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/css/listainscricao200k.css"/>
    <title>Lista de Inscrições - Coordenador</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid main-container">
        <!-- Seção de Autenticação -->
        <div id="authSection">
            <div class="card">
                <div class="card-header bg-primary text-white text-center">
                    <h4><i class="fas fa-lock me-2"></i>Acesso do Coordenador</h4>
                </div>
                <div class="card-body">
                    <form id="authForm">
                        <div class="mb-3">
                            <label for="senha" class="form-label">Senha de Acesso:</label>
                            <input type="password" class="form-control" id="senha" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>Entrar
                        </button>
                    </form>
                    <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div id="mainContent">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-running me-2"></i>Gerenciamento de Inscrições</h4>
                            <button id="logoutBtn" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-sign-out-alt me-1"></i>Sair
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="eventoSelect" class="form-label">Selecione o Evento:</label>
                                    <select id="eventoSelect" class="form-select">
                                        <option value="">Selecione um evento...</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="modalidadeSelect" class="form-label">Modalidade:</label>
                                    <select id="modalidadeSelect" class="form-select" disabled>
                                        <option value="">Todas as modalidades</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Inscrições -->
            <div id="inscricoesSection" style="display: none;">
                <div class="card">
                    <div class="card-header bg-info text-white d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <h5 class="mb-2 mb-md-0"><i class="fas fa-list me-2"></i>Lista de Atletas Inscritos</h5>
                        <span class="total-registros badge bg-light text-dark" id="totalRegistros">0 atletas</span>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="filter-container">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="filter-group">
                                        <div class="filter-title">Sexo:</div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="sexoTodos" value="todos" checked>
                                            <label class="form-check-label" for="sexoTodos">Todos</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="sexoM" value="M">
                                            <label class="form-check-label" for="sexoM">Masculino</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="sexoF" value="F">
                                            <label class="form-check-label" for="sexoF">Feminino</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="filter-group">
                                        <div class="filter-title">Camiseta:</div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="camisetaTodos" value="todos" checked>
                                            <label class="form-check-label" for="camisetaTodos">Todos</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="camisetaPP" value="PP">
                                            <label class="form-check-label" for="camisetaPP">PP</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="camisetaP" value="P">
                                            <label class="form-check-label" for="camisetaP">P</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="camisetaM" value="M">
                                            <label class="form-check-label" for="camisetaM">M</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="camisetaG" value="G">
                                            <label class="form-check-label" for="camisetaG">G</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Atleta</th>
                                        <th class="d-none d-md-table-cell">Camiseta</th>
                                        <th class="d-none d-lg-table-cell">Modalidade</th>
                                        <th style="width: 60px;" class="text-center">Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody id="inscricoesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botão Equipes -->
            <div class="row mt-3" id="equipesButtonSection" style="display: none;">
                <div class="col-12">
                    <button id="equipesBtn" class="btn btn-success">
                        <i class="fas fa-users me-2"></i>Equipes
                    </button>
                </div>
            </div>

            <!-- Botão Apoio Organização -->
            <div class="row mt-3" id="apoioOrganizacaoButtonSection" style="display: none;">
                <div class="col-12">
                    <button id="apoioOrganizacaoBtn" class="btn btn-info">
                        <i class="fas fa-hands-helping me-2"></i>Apoio Organização
                    </button>
                </div>
            </div>

            <!-- Modal Principal de Equipes -->
            <div class="modal fade" id="equipesModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title"><i class="fas fa-users me-2"></i>Equipes</h5>
                            <button type="button" class="btn-close btn-close-white" id="closeEquipesModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Lista Equipes</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Nome da Equipe</th>
                                                    <th>Modalidade</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="equipesTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3">
                                        <button id="montarEquipeBtn" class="btn btn-primary">
                                            <i class="fas fa-plus me-2"></i>Montar Equipe
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Montar Equipe -->
            <div class="modal fade" id="montarEquipeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Montar Equipe</h5>
                            <button type="button" class="btn-close btn-close-white" id="closeMontarEquipeModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="modalidadeEquipeSelect" class="form-label">Modalidade:</label>
                                <select id="modalidadeEquipeSelect" class="form-select">
                                    <option value="">Selecione uma modalidade...</option>
                                </select>
                            </div>
                            
                            <div id="atletasSection" style="display: none;">
                                <div class="card">
                                    <div class="card-header">
                                        <h6>Atletas Disponíveis</h6>
                                        <small class="text-muted">Obrigatório <span id="maxAtletas">0</span> atletas por equipe</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th width="50">Selecionar</th>
                                                        <th>Atleta</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="atletasDisponiveisBody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <label for="nomeEquipeInput" class="form-label">Nome da Equipe:</label>
                                    <input type="text" class="form-control" id="nomeEquipeInput" maxlength="45">
                                </div>
                                
                                <div class="mt-3">
                                    <button id="criarEquipeBtn" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>Criar Equipe
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Editar Equipe -->
            <div class="modal fade" id="editarEquipeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Equipe</h5>
                            <button type="button" class="btn-close" id="closeEditarEquipeModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="card">
                                <div class="card-header">
                                    <h6 id="tituloEquipeEdicao">Equipe: </h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Atleta</th>
                                                    <th>Ordem</th>
                                                    <th>KM Início</th>
                                                    <th>KM Fim</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="atletasEquipeBody">
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3" id="salvarOrdemDiv" style="display: none;">
                                        <button id="salvarOrdemBtn" class="btn btn-success">
                                            <i class="fas fa-save me-2"></i>Salvar Alterações
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Inscrição -->
    <div class="modal fade" id="detalhesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Detalhes da Inscrição</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="detalhesContent">
                        <!-- Conteúdo será preenchido dinamicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary me-3" role="status"></div>
                    <span>Carregando...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let loadingModal;
        let allInscricoes = []; // Array para armazenar todas as inscrições
        let filteredInscricoes = []; // Array para inscrições filtradas

        let equipesModal, montarEquipeModal, editarEquipeModal;
        let maxAtletasPorEquipe = 0;
        let atletasSelecionados = [];
        let equipeAtual = null;
        let atletasEquipeAtual = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            
            // Event Listeners
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            document.getElementById('eventoSelect').addEventListener('change', handleEventoChange);
            document.getElementById('modalidadeSelect').addEventListener('change', handleModalidadeChange);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Event listeners para filtros
            setupFilters();

            // Event listeners para equipes
            document.getElementById('equipesBtn').addEventListener('click', openEquipesModal);
            document.getElementById('closeEquipesModal').addEventListener('click', closeEquipesModal);
            document.getElementById('montarEquipeBtn').addEventListener('click', openMontarEquipeModal);
            document.getElementById('closeMontarEquipeModal').addEventListener('click', closeMontarEquipeModal);
            document.getElementById('modalidadeEquipeSelect').addEventListener('change', handleModalidadeEquipeChange);
            document.getElementById('criarEquipeBtn').addEventListener('click', criarEquipe);
            document.getElementById('closeEditarEquipeModal').addEventListener('click', closeEditarEquipeModal);
            document.getElementById('salvarOrdemBtn').addEventListener('click', salvarOrdemEquipe);

            // Event listeners para apoio organização
            document.getElementById('apoioOrganizacaoBtn').addEventListener('click', openApoioOrganizacao);
            
            initEquipesModals();

        });

        function setupFilters() {
            // Filtros de sexo
            const sexoFilters = ['sexoTodos', 'sexoM', 'sexoF'];
            sexoFilters.forEach(id => {
                document.getElementById(id).addEventListener('change', handleSexoFilter);
            });
            
            // Filtros de camiseta
            const camisetaFilters = ['camisetaTodos', 'camisetaPP', 'camisetaP', 'camisetaM', 'camisetaG'];
            camisetaFilters.forEach(id => {
                document.getElementById(id).addEventListener('change', handleCamisetaFilter);
            });
        }

        function handleSexoFilter(e) {
            if (e.target.value === 'todos') {
                // Se "Todos" foi marcado, desmarcar os outros
                if (e.target.checked) {
                    document.getElementById('sexoM').checked = false;
                    document.getElementById('sexoF').checked = false;
                }
            } else {
                // Se um específico foi marcado, desmarcar "Todos"
                if (e.target.checked) {
                    document.getElementById('sexoTodos').checked = false;
                }
            }
            applyFilters();
        }

        function handleCamisetaFilter(e) {
            if (e.target.value === 'todos') {
                // Se "Todos" foi marcado, desmarcar os outros
                if (e.target.checked) {
                    ['camisetaPP', 'camisetaP', 'camisetaM', 'camisetaG'].forEach(id => {
                        document.getElementById(id).checked = false;
                    });
                }
            } else {
                // Se um específico foi marcado, desmarcar "Todos"
                if (e.target.checked) {
                    document.getElementById('camisetaTodos').checked = false;
                }
            }
            applyFilters();
        }

        function applyFilters() {
            // Obter filtros de sexo selecionados
            const sexoSelecionados = [];
            if (document.getElementById('sexoTodos').checked) {
                sexoSelecionados.push('todos');
            } else {
                if (document.getElementById('sexoM').checked) sexoSelecionados.push('M');
                if (document.getElementById('sexoF').checked) sexoSelecionados.push('F');
            }

            // Obter filtros de camiseta selecionados
            const camisetaSelecionadas = [];
            if (document.getElementById('camisetaTodos').checked) {
                camisetaSelecionadas.push('todos');
            } else {
                ['PP', 'P', 'M', 'G'].forEach(size => {
                    if (document.getElementById(`camiseta${size}`).checked) {
                        camisetaSelecionadas.push(size);
                    }
                });
            }

            // Aplicar filtros
            filteredInscricoes = allInscricoes.filter(inscricao => {
                // Filtro de sexo
                const sexoMatch = sexoSelecionados.includes('todos') || 
                                 sexoSelecionados.includes(inscricao.SEXO) ||
                                 sexoSelecionados.length === 0;

                // Filtro de camiseta
                const camisetaMatch = camisetaSelecionadas.includes('todos') || 
                                     camisetaSelecionadas.includes(inscricao.CAMISETA) ||
                                     camisetaSelecionadas.length === 0;

                return sexoMatch && camisetaMatch;
            });

            displayInscricoes(filteredInscricoes);
        }

        async function handleAuth(e) {
            e.preventDefault();
            const senha = document.getElementById('senha').value;
            
            try {
                loadingModal.show();
                const response = await fetch('/verificar_senha1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ senha: senha })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    await loadEventos();
                } else {
                    showError(data.message || 'Senha incorreta');
                }
            } catch (error) {
                showError('Erro ao verificar senha');
            } finally {
                loadingModal.hide();
            }
        }

        async function loadEventos() {
            try {
                const response = await fetch('/api/eventos1');
                const eventos = await response.json();
                
                const select = document.getElementById('eventoSelect');
                select.innerHTML = '<option value="">Selecione um evento...</option>';
                
                eventos.forEach(evento => {
                    const option = document.createElement('option');
                    option.value = evento.IDEVENTO;
                    option.textContent = evento.DESCRICAO;
                    select.appendChild(option);
                });
            } catch (error) {
                showError('Erro ao carregar eventos');
            }
        }

        async function handleEventoChange(e) {
            const eventoId = e.target.value;
            const modalidadeSelect = document.getElementById('modalidadeSelect');
            
            if (!eventoId) {
                document.getElementById('inscricoesSection').style.display = 'none';
                modalidadeSelect.disabled = true;
                modalidadeSelect.innerHTML = '<option value="">Todas as modalidades</option>';
                return;
            }
            
            try {
                loadingModal.show();
                
                // Carregar modalidades do evento
                await loadModalidades(eventoId);
                modalidadeSelect.disabled = false;
                
                // Carregar todas as inscrições do evento
                const response = await fetch(`/api/inscricoes/${eventoId}`);
                const inscricoes = await response.json();
                
                allInscricoes = inscricoes;
                filteredInscricoes = inscricoes;
                displayInscricoes(inscricoes);
                document.getElementById('inscricoesSection').style.display = 'block';
                document.getElementById('equipesButtonSection').style.display = 'block';
                document.getElementById('apoioOrganizacaoButtonSection').style.display = 'block';
            } catch (error) {
                showError('Erro ao carregar dados do evento');
            } finally {
                loadingModal.hide();
            }
        }

        async function loadModalidades(eventoId) {
            try {
                const response = await fetch(`/api/modalidades1/${eventoId}`);
                const modalidades = await response.json();
                
                const select = document.getElementById('modalidadeSelect');
                select.innerHTML = '<option value="">Todas as modalidades</option>';
                
                modalidades.forEach(modalidade => {
                    const option = document.createElement('option');
                    option.value = modalidade.IDITEM;
                    option.textContent = modalidade.DESCRICAO;
                    select.appendChild(option);
                });
            } catch (error) {
                showError('Erro ao carregar modalidades');
            }
        }

        async function handleModalidadeChange(e) {
            const eventoId = document.getElementById('eventoSelect').value;
            const modalidadeId = e.target.value;
            
            if (!eventoId) return;
            
            try {
                loadingModal.show();
                
                let url = `/api/inscricoes/${eventoId}`;
                if (modalidadeId) {
                    url += `/${modalidadeId}`;
                }
                
                const response = await fetch(url);
                const inscricoes = await response.json();
                
                allInscricoes = inscricoes;
                applyFilters(); // Aplicar filtros existentes
            } catch (error) {
                showError('Erro ao filtrar inscrições');
            } finally {
                loadingModal.hide();
            }
        }

        function displayInscricoes(inscricoes) {
            const tbody = document.getElementById('inscricoesTableBody');
            const totalElement = document.getElementById('totalRegistros');
            
            tbody.innerHTML = '';
            
            // Contar apenas inscrições não canceladas
            const inscricoesAtivas = inscricoes.filter(i => i.FLSTATUS !== 'CANCELADO');
            totalElement.textContent = `${inscricoesAtivas.length} atleta${inscricoesAtivas.length !== 1 ? 's' : ''}`;
            
            inscricoes.forEach(inscricao => {
                const sexoBadge = inscricao.SEXO === 'M' ? 
                    '<span class="badge bg-primary sexo-badge">M</span>' : 
                    inscricao.SEXO === 'F' ? 
                    '<span class="badge bg-danger sexo-badge">F</span>' : '';
                
                // Definir classes CSS baseadas no status
                let rowClass = '';
                let textStyle = '';
                
                if (inscricao.FLSTATUS === 'PENDENTE') {
                    textStyle = 'color: red;';
                } else if (inscricao.FLSTATUS === 'CANCELADO') {
                    textStyle = 'color: red; text-decoration: line-through;';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span style="${textStyle}">${inscricao.ATLETA}</span>${sexoBadge}
                        <div class="d-md-none small text-muted">
                            <span style="${textStyle}">${inscricao.CAMISETA ? `Camiseta: ${inscricao.CAMISETA}` : ''}</span>
                            <br class="d-lg-none"><span style="${textStyle}">${inscricao.DESCRICAO}</span>
                        </div>
                    </td>
                    <td class="d-none d-md-table-cell"><span style="${textStyle}">${inscricao.CAMISETA || '-'}</span></td>
                    <td class="d-none d-lg-table-cell"><span style="${textStyle}">${inscricao.DESCRICAO}</span></td>
                    <td class="text-center">
                        <button class="btn-details" onclick="showDetalhes(${inscricao.IDINSCRICAO})" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function showDetalhes(inscricaoId) {
            try {
                loadingModal.show();
                const response = await fetch(`/api/inscricao/${inscricaoId}`);
                const inscricao = await response.json();
                
                displayDetalhes(inscricao);
                const modal = new bootstrap.Modal(document.getElementById('detalhesModal'));
                modal.show();
            } catch (error) {
                showError('Erro ao carregar detalhes da inscrição');
            } finally {
                loadingModal.hide();
            }
        }

        function displayDetalhes(inscricao) {
            const content = document.getElementById('detalhesContent');
            content.innerHTML = `
                <div class="col-12 mb-3">
                    <h6 class="text-primary border-bottom pb-2">Dados do Atleta</h6>
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Nome Completo:</strong><br>
                    ${inscricao.NOME_COMPLETO}
                </div>
                <div class="col-md-3 mb-3">
                    <strong>Data Nascimento:</strong><br>
                    ${inscricao.DTNASCIMENTO || '-'}
                </div>
                <div class="col-md-3 mb-3">
                    <strong>Sexo:</strong><br>
                    ${inscricao.SEXO === 'M' ? 'Masculino' : inscricao.SEXO === 'F' ? 'Feminino' : '-'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Nº Celular:</strong><br>
                    ${inscricao.NRCELULAR || '-'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>CPF:</strong><br>
                    ${inscricao.CPF || '-'}
                </div>
                
                <div class="col-12 mb-3 mt-4">
                    <h6 class="text-primary border-bottom pb-2">Dados da Inscrição</h6>
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Modalidade:</strong><br>
                    ${inscricao.MODALIDADE}
                </div>
                <div class="col-md-3 mb-3">
                    <strong>Camiseta:</strong><br>
                    ${inscricao.CAMISETA || '-'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Apoio:</strong><br>
                    ${inscricao.APOIO || '-'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Equipe:</strong><br>
                    ${inscricao.EQUIPE || '-'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Nome da Equipe:</strong><br>
                    ${inscricao.NOME_EQUIPE || '-'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Cupom:</strong><br>
                    ${inscricao.CUPOM || '-'}
                </div>
                <div class="col-12 mb-3">
                    <strong>Integrantes:</strong><br>
                    ${inscricao.INTEGRANTES || '-'}
                </div>
                
                <div class="col-12 mb-3 mt-4">
                    <h6 class="text-primary border-bottom pb-2">Edição</h6>
                </div>
                <div class="col-md-3 mb-3">
                    <strong>Valor:</strong><br>
                    <input type="text" class="form-control valor-input" id="valorEdit" 
                        value="${formatCurrency(inscricao.VALOR)}" 
                        data-valor="${inscricao.VALOR}">
                </div>
                <div class="col-md-3 mb-3">
                    <strong>Taxa:</strong><br>
                    <input type="text" class="form-control valor-input" id="taxaEdit" 
                        value="${formatCurrency(inscricao.TAXA)}" 
                        data-valor="${inscricao.TAXA}">
                </div>
                <div class="col-md-3 mb-3">
                    <strong>Desconto:</strong><br>
                    <input type="text" class="form-control valor-input" id="descontoEdit" 
                        value="${formatCurrency(inscricao.DESCONTO)}" 
                        data-valor="${inscricao.DESCONTO}">
                </div>
                <div class="col-md-3 mb-3">
                    <strong>Valor Pago:</strong><br>
                    <input type="text" class="form-control" id="valorPagoEdit" 
                        value="${formatCurrency(inscricao.VALOR_PGTO)}" readonly 
                        style="background-color: #f8f9fa;">
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Forma de Pagto:</strong><br>
                    <select class="form-select" id="fpagtoEdit">
                        <option value="PIX" ${inscricao.FORMAPGTO === 'PIX' ? 'selected' : ''}>PIX</option>
                        <option value="CARTAO DE CREDITO" ${inscricao.FORMAPGTO === 'CARTAO DE CREDITO' ? 'selected' : ''}>Cartão de Crédito</option>
                        <option value="DINHEIRO" ${inscricao.FORMAPGTO === 'DINHEIRO' ? 'selected' : ''}>Dinheiro</option>
                        <option value="OUTRO" ${inscricao.FORMAPGTO === 'OUTRO' ? 'selected' : ''}>Outro</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Status da Inscrição:</strong><br>
                    <select class="form-select" id="statusEdit">
                        <option value="CONFIRMADO" ${inscricao.FLSTATUS === 'CONFIRMADO' ? 'selected' : ''}>Confirmado</option>
                        <option value="PENDENTE" ${inscricao.FLSTATUS === 'PENDENTE' ? 'selected' : ''}>Pendente</option>
                        <option value="CANCELADO" ${inscricao.FLSTATUS === 'CANCELADO' ? 'selected' : ''}>Cancelado</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <strong>Nº de Peito:</strong><br>
                    <input type="text" id="peitoEdit" 
                        value="${inscricao.NUPEITO}" 
                        data-valor="${inscricao.NUPEITO}">
                </div>
                
                <div class="col-12 mt-3">
                    <button type="button" class="btn btn-success" onclick="salvarAlteracoes(${inscricao.IDINSCRICAO})">
                        <i class="fas fa-save me-2"></i>Salvar Alterações
                    </button>
                </div>
               
                <div class="col-12 mb-3 mt-4">
                    <h6 class="text-primary border-bottom pb-2">Lista de Apoios</h6>
                    <div id="apoiosContainer">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            Carregando apoios...
                        </div>
                    </div>
                </div>                
            `;
            
            // Aplicar formatação nos inputs de valor
            setupValorInputs();
            
            // Carregar lista de apoios
            loadApoios(inscricao.IDATLETA);
        }

        // Função para carregar apoios do atleta
        async function loadApoios(atletaId) {
            try {
                const response = await fetch(`/api/apoios/${atletaId}`);
                const apoios = await response.json();
                
                const container = document.getElementById('apoiosContainer');
                
                if (apoios.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Nenhum apoio cadastrado para este atleta.
                        </div>
                    `;
                } else {
                    let apoiosHtml = `
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Celular</th>
                                        <th>Veículo/Placa</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    apoios.forEach(apoio => {
                        apoiosHtml += `
                            <tr>
                                <td>${apoio.NOME}</td>
                                <td>${apoio.CELULAR || '-'}</td>
                                <td>${apoio.VEICULO_PLACA || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    apoiosHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = apoiosHtml;
                }
                
            } catch (error) {
                console.error('Erro ao carregar apoios:', error);
                const container = document.getElementById('apoiosContainer');
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Erro ao carregar lista de apoios.
                    </div>
                `;
            }
        }

        // Função para configurar inputs de valor com formatação
        function setupValorInputs() {
            const valorInputs = document.querySelectorAll('.valor-input');
            
            valorInputs.forEach(input => {
                // Formatação ao digitar
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = (parseFloat(value) / 100).toFixed(2);
                    e.target.value = formatCurrency(parseFloat(value));
                    e.target.dataset.valor = parseFloat(value);
                    calcularValorPago();
                });
                
                // Formatação ao perder foco
                input.addEventListener('blur', function(e) {
                    const valor = parseFloat(e.target.dataset.valor) || 0;
                    e.target.value = formatCurrency(valor);
                });
            });
            
            // Calcular valor pago inicial
            calcularValorPago();
        }

        // Função para calcular valor pago automaticamente
        function calcularValorPago() {
            const valor = parseFloat(document.getElementById('valorEdit')?.dataset.valor) || 0;
            const taxa = parseFloat(document.getElementById('taxaEdit')?.dataset.valor) || 0;
            const desconto = parseFloat(document.getElementById('descontoEdit')?.dataset.valor) || 0;
            
            const valorPago = valor + taxa - desconto;
            const valorPagoInput = document.getElementById('valorPagoEdit');
            if (valorPagoInput) {
                valorPagoInput.value = formatCurrency(valorPago);
            }
        }

        // Função para salvar alterações
        async function salvarAlteracoes(inscricaoId) {
            const formapagto = document.getElementById('fpagtoEdit').value;
            const valor = parseFloat(document.getElementById('valorEdit').dataset.valor) || 0;
            const taxa = parseFloat(document.getElementById('taxaEdit').dataset.valor) || 0;
            const desconto = parseFloat(document.getElementById('descontoEdit').dataset.valor) || 0;
            const status = document.getElementById('statusEdit').value;
            const npeito = document.getElementById('peitoEdit').value;
            
            
            try {
                loadingModal.show();
                
                const response = await fetch('/api/atualizar-inscricao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inscricaoId: inscricaoId,
                        formapagto: formapagto,
                        valor: valor,
                        taxa: taxa,
                        desconto: desconto,
                        status: status,
                        npeito: npeito
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Inscrição atualizada com sucesso!');
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('detalhesModal')).hide();
                    // Recarregar lista
                    const eventoId = document.getElementById('eventoSelect').value;
                    if (eventoId) {
                        await handleEventoChange({ target: { value: eventoId } });
                    }
                } else {
                    showError(result.message || 'Erro ao atualizar inscrição');
                }
                
            } catch (error) {
                showError('Erro ao salvar alterações');
            } finally {
                loadingModal.hide();
            }
        }        
        
        function formatCurrency(value) {
            return (value || 0).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        async function handleLogout() {
            try {
                await fetch('/logout_coordenador', {
                    method: 'POST'
                });
                
                // Reset da interface
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('senha').value = '';
                document.getElementById('eventoSelect').value = '';
                document.getElementById('modalidadeSelect').value = '';
                document.getElementById('modalidadeSelect').disabled = true;
                document.getElementById('inscricoesSection').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                
                // Reset filtros
                document.getElementById('sexoTodos').checked = true;
                document.getElementById('sexoM').checked = false;
                document.getElementById('sexoF').checked = false;
                document.getElementById('camisetaTodos').checked = true;
                ['PP', 'P', 'M', 'G'].forEach(size => {
                    document.getElementById(`camiseta${size}`).checked = false;
                });
                
                document.getElementById('apoioOrganizacaoButtonSection').style.display = 'none';
                
                allInscricoes = [];
                filteredInscricoes = [];
            } catch (error) {
                console.error('Erro no logout:', error);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // ===== FUNÇÕES PARA SISTEMA DE EQUIPES =====
        // Inicializar modais
        function initEquipesModals() {
            equipesModal = new bootstrap.Modal(document.getElementById('equipesModal'));
            montarEquipeModal = new bootstrap.Modal(document.getElementById('montarEquipeModal'));
            editarEquipeModal = new bootstrap.Modal(document.getElementById('editarEquipeModal'));
        }

        // Abrir modal de equipes
        async function openEquipesModal() {
            const eventoId = document.getElementById('eventoSelect').value;
            if (!eventoId) {
                showError('Selecione um evento primeiro');
                return;
            }
            
            await loadEquipes(eventoId);
            equipesModal.show();
        }

        // Fechar modal de equipes
        function closeEquipesModal() {
            equipesModal.hide();
        }

        // Carregar lista de equipes
        async function loadEquipes(eventoId) {
            try {
                loadingModal.show();
                const response = await fetch(`/api/equipes/${eventoId}`);
                const equipes = await response.json();
                
                const tbody = document.getElementById('equipesTableBody');
                tbody.innerHTML = '';
                
                equipes.forEach(equipe => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${equipe.IDEA}</td>
                        <td>${equipe.NOME_EQUIPE}</td>
                        <td>${equipe.DESCRICAO}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="abrirEditarEquipe(${equipe.IDEA})">
                                <i class="fas fa-edit"></i> Abrir
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                showError('Erro ao carregar equipes');
            } finally {
                loadingModal.hide();
            }
        }

        // Abrir modal para montar equipe
        async function openMontarEquipeModal() {
            const eventoId = document.getElementById('eventoSelect').value;
            if (!eventoId) {
                showError('Selecione um evento primeiro');
                return;
            }
            
            // Carregar modalidades no select
            try {
                const response = await fetch(`/api/modalidades2/${eventoId}`);
                const modalidades = await response.json();
                
                const select = document.getElementById('modalidadeEquipeSelect');
                select.innerHTML = '<option value="">Selecione uma modalidade...</option>';
                
                modalidades.forEach(modalidade => {
                    const option = document.createElement('option');
                    option.value = modalidade.IDITEM;
                    option.textContent = modalidade.DESCRICAO;
                    select.appendChild(option);
                });
                
                // Reset form
                document.getElementById('atletasSection').style.display = 'none';
                document.getElementById('nomeEquipeInput').value = '';
                atletasSelecionados = [];
                
                montarEquipeModal.show();
            } catch (error) {
                showError('Erro ao carregar modalidades');
            }
        }

        // Fechar modal montar equipe
        function closeMontarEquipeModal() {
            montarEquipeModal.hide();
        }

        // Handle mudança de modalidade no form de equipe
        async function handleModalidadeEquipeChange(e) {
            const modalidadeId = e.target.value;
            const eventoId = document.getElementById('eventoSelect').value;
            
            if (!modalidadeId) {
                document.getElementById('atletasSection').style.display = 'none';
                return;
            }
            
            try {
                loadingModal.show();
                
                // Buscar dados da modalidade (número de atletas)
                const modalidadeResponse = await fetch(`/api/modalidade1/${modalidadeId}`);
                const modalidadeData = await modalidadeResponse.json();
                maxAtletasPorEquipe = modalidadeData.NU_ATLETAS;
                
                document.getElementById('maxAtletas').textContent = maxAtletasPorEquipe;
                
                // Buscar atletas disponíveis
                const atletasResponse = await fetch(`/api/atletas-disponiveis/${eventoId}/${modalidadeId}`);
                const atletas = await atletasResponse.json(); // CORREÇÃO AQUI
                
                displayAtletasDisponiveis(atletas);
                document.getElementById('atletasSection').style.display = 'block';
                
            } catch (error) {
                showError('Erro ao carregar atletas disponíveis');
            } finally {
                loadingModal.hide();
            }
        }        
    
        
        // Exibir atletas disponíveis
        function displayAtletasDisponiveis(atletas) {
            const tbody = document.getElementById('atletasDisponiveisBody');
            tbody.innerHTML = '';
            
            atletas.forEach(atleta => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input" 
                            id="atleta_${atleta.IDATLETA}" 
                            value="${atleta.IDATLETA}"
                            onchange="handleAtletaSelection(this, '${atleta.ATLETA}')">
                    </td>
                    <td>
                        <label for="atleta_${atleta.IDATLETA}">${atleta.ATLETA}</label>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Handle seleção de atletas
        function handleAtletaSelection(checkbox, nomeAtleta) {
            if (checkbox.checked) {
                if (atletasSelecionados.length >= maxAtletasPorEquipe) {
                    checkbox.checked = false;
                    showError(`Obrigatório ${maxAtletasPorEquipe} atletas por equipe`);
                    return;
                }
                atletasSelecionados.push({
                    IDATLETA: parseInt(checkbox.value),
                    NOME: nomeAtleta
                });
            } else {
                atletasSelecionados = atletasSelecionados.filter(a => a.IDATLETA !== parseInt(checkbox.value));
            }
        }

        // Criar equipe
        async function criarEquipe() {
            console.log('DEBUG: Função criarEquipe chamada');
            
            const nomeEquipe = document.getElementById('nomeEquipeInput').value.trim();
            const eventoId = document.getElementById('eventoSelect').value;
            const modalidadeId = document.getElementById('modalidadeEquipeSelect').value;
            
            console.log('DEBUG: Valores capturados:', {
                nomeEquipe,
                eventoId,
                modalidadeId,
                atletasSelecionados,
                maxAtletasPorEquipe
            });
            
            // Validações
            if (!nomeEquipe) {
                console.log('DEBUG: Erro - Nome da equipe vazio');
                showError('Nome da equipe é obrigatório');
                return;
            }
            
            if (atletasSelecionados.length !== maxAtletasPorEquipe) {
                console.log('DEBUG: Erro - Número de atletas incorreto');
                showError(`Selecione exatamente ${maxAtletasPorEquipe} atletas para formar a equipe`);
                return;
            }
            
            console.log('DEBUG: Validações passaram, enviando requisição...');
            
            try {
                loadingModal.show();
                
                const response = await fetch('/api/criar-equipe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        eventoId: eventoId,
                        modalidadeId: modalidadeId,
                        nomeEquipe: nomeEquipe,
                        atletas: atletasSelecionados
                    })
                });
                
                console.log('DEBUG: Response recebida:', response.status);
                
                const result = await response.json();
                console.log('DEBUG: Result:', result);
                
                if (result.success) {
                    montarEquipeModal.hide();
                    await loadEquipes(eventoId);
                    showSuccess('Equipe criada com sucesso!');
                } else {
                    showError(result.message || 'Erro ao criar equipe');
                }
                
            } catch (error) {
                console.log('DEBUG: Erro na requisição:', error);
                showError('Erro ao criar equipe');
            } finally {
                loadingModal.hide();
            }
        }

        // Abrir edição de equipe
        async function abrirEditarEquipe(equipeId) {
            try {
                loadingModal.show();
                
                const response = await fetch(`/api/equipe-atletas/${equipeId}`);
                const data = await response.json();
                
                equipeAtual = data.equipe;
                atletasEquipeAtual = [...data.atletas];
                
                document.getElementById('tituloEquipeEdicao').textContent = `Equipe: ${equipeAtual.NOME_EQUIPE}`;
                
                displayAtletasEquipe(atletasEquipeAtual);
                editarEquipeModal.show();
                
            } catch (error) {
                showError('Erro ao carregar dados da equipe');
            } finally {
                loadingModal.hide();
            }
        }

        // Exibir atletas da equipe
        function displayAtletasEquipe(atletas) {
            const tbody = document.getElementById('atletasEquipeBody');
            tbody.innerHTML = '';
            
            atletas.forEach((atleta, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${atleta.ATLETA}</td>
                    <td>${atleta.ORDEM}</td>
                    <td>${atleta.KM_INI}</td>
                    <td>${atleta.KM_FIM}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" 
                                onclick="moverAtleta(${index}, 'up')"
                                ${index === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="moverAtleta(${index}, 'down')"
                                ${index === atletas.length - 1 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Mover atleta na ordem
        function moverAtleta(index, direction) {
            if (direction === 'up' && index > 0) {
                // Trocar apenas os nomes dos atletas, mantendo as outras informações fixas
                const nomeTemp = atletasEquipeAtual[index].ATLETA;
                const idTemp = atletasEquipeAtual[index].IDATLETA;
                
                atletasEquipeAtual[index].ATLETA = atletasEquipeAtual[index - 1].ATLETA;
                atletasEquipeAtual[index].IDATLETA = atletasEquipeAtual[index - 1].IDATLETA;
                
                atletasEquipeAtual[index - 1].ATLETA = nomeTemp;
                atletasEquipeAtual[index - 1].IDATLETA = idTemp;
                
            } else if (direction === 'down' && index < atletasEquipeAtual.length - 1) {
                // Trocar apenas os nomes dos atletas, mantendo as outras informações fixas
                const nomeTemp = atletasEquipeAtual[index].ATLETA;
                const idTemp = atletasEquipeAtual[index].IDATLETA;
                
                atletasEquipeAtual[index].ATLETA = atletasEquipeAtual[index + 1].ATLETA;
                atletasEquipeAtual[index].IDATLETA = atletasEquipeAtual[index + 1].IDATLETA;
                
                atletasEquipeAtual[index + 1].ATLETA = nomeTemp;
                atletasEquipeAtual[index + 1].IDATLETA = idTemp;
            }
            
            displayAtletasEquipe(atletasEquipeAtual);
            document.getElementById('salvarOrdemDiv').style.display = 'block';
        }

 
        // Salvar nova ordem dos atletas
        async function salvarOrdemEquipe() {
            try {
                loadingModal.show();
                
                const response = await fetch('/api/salvar-ordem-equipe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        equipeId: equipeAtual.IDEA,
                        atletas: atletasEquipeAtual.map((atleta, index) => ({
                            ordem: index + 1,
                            idatleta: atleta.IDATLETA
                        }))
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('salvarOrdemDiv').style.display = 'none';
                    showSuccess('Ordem dos atletas salva com sucesso!');
                } else {
                    showError(result.message || 'Erro ao salvar ordem');
                }
                
            } catch (error) {
                showError('Erro ao salvar ordem dos atletas');
            } finally {
                loadingModal.hide();
            }
        }

        // Fechar modal editar equipe
        function closeEditarEquipeModal() {
            editarEquipeModal.hide();
            document.getElementById('salvarOrdemDiv').style.display = 'none';
        }

        // Função para mostrar sucesso
        function showSuccess(message) {
            // Criar um alert de sucesso temporário
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // ===== FUNÇÃO PARA APOIO ORGANIZAÇÃO =====
        function openApoioOrganizacao() {
            // Abrir nova aba/janela para a página de administração do apoio
            window.open('/admin-apoio', '_blank');
        }

    </script>
</body>
</html>
