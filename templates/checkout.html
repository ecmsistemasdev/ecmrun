<!DOCTYPE html>
<html>
<head>
    <title>Pagamento Cartão - 4º Desafio 200k</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .form-title {
            background-color: #647e99;
            color: white;
            padding: 10px;
            margin: -20px -20px 20px -20px;
            border-radius: 7px 7px 0 0;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        form {
            max-width: 500px;
            margin: 5px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            text-align: center;
        }

        .form-control {
            height: 40px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            background-color: white;
            font-size: 14px;
            width: 100%;
        }        

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
            min-width: 0;
        }

        .form-row.doc-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            width: 100%;
        }

        .form-col.doc-type {
            flex: 1;
            min-width: 140px;
            max-width: 140px;
        }

        .form-col.doc-number {
            flex: 3;
        }

        .form-row.doc-row input,
        .form-row.doc-row select {
            width: 100%;
            height: 40px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, 
        .form-group select {
            width: 100%;
            height: 40px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, 
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #45a049;
        }

        .card-fields-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }        

        .card-field-col {
            flex: 1;
            min-width: 0;
        }

        .expiry-field,
        .cvv-field {
            flex: 1;
        }

        /* Garante que todos os inputs e selects tenham a mesma altura */
        .form-group input,
        .form-group select,
        input#expiration-date,
        input#security-code {
            width: 100%;
            height: 40px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        } 

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-text {
            font-size: 14px;
            color: #333;
        }

        /* Estilo para inputs desabilitados */
        input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }


        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            form {
                padding: 15px;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .form-col {
                width: 100%;
            }

            .card-fields-row {
                flex-direction: row;
                gap: 15px;
            }
            
            .form-row.doc-row {
                flex-direction: row;
                width: 100%;
            }

            .form-col.doc-type {
                flex: 1;
                min-width: 120px;
                max-width: 120px;
            }           

            .form-col.doc-number {
                flex: 2;
            }

            .form-group label {
                font-size: 16px;
            }

            .form-group input, 
            .form-group select,
            .form-control {
                font-size: 16px;
                height: 44px;
            }

            button {
                padding: 14px;
                font-size: 18px;
            }           
        }

        .form-group input:invalid,
        .form-group select:invalid {
            border-color: #dc3545;
        }

        .document-error {
            border-color: #dc3545 !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .footer {
            width: 500px;
            background-color: white;
            padding: 20px 0;
            margin-top: auto;
            text-align: center;
            align-items: center;
            justify-self: center;
        }

        .footer-logo {
            height: 50px;
            width: auto;
            margin-bottom: 10px;
        }

        .footer-text {
            font-size: 0.7em;
            color: #333;
            margin: 2px 0;
        }        

        .selo-text {
            font-size: 0.6em;
            text-align: justify;
            color: #333;
            margin: 2px 0;
        }        


    </style>
</head>
<body>
    <form id="payment-form">
        <div class="form-title">Pagamento com Cartão de Crédito</div>

        <div class="form-group">
            <label class="checkbox-container">
                <input type="checkbox" id="same-user-data" name="same_user_data">
                <span class="checkbox-text">Utilizar os mesmos dados da inscrição para o pagamento</span>
            </label>
        </div>

        <div class="form-group">
            <div>Valor do Pagamento:</div>
            <div class="total-amount" id="transaction-amount">Carregando...</div>
        </div>

        <div class="form-group">
            <label>Nome no Cartão</label>
            <input 
                type="text" 
                name="card_holder_name" 
                id="card_holder_name"
                placeholder="Nome completo" 
                required
            >
        </div>

        <div class="form-group">
            <label>Número do Cartão</label>
            <input 
                type="text" 
                id="card-number" 
                placeholder="Número do cartão" 
                maxlength="19" 
                pattern="\d{4}\s\d{4}\s\d{4}\s\d{4}"
                required
            >
        </div>

        <div class="card-fields-row">
            <div class="form-col expiry-field">
                <label>Data de Validade</label>
                <input 
                    type="text" 
                    id="expiration-date" 
                    placeholder="MM/AA" 
                    maxlength="5" 
                    pattern="\d{2}/\d{2}"
                    required
                >
            </div>
        
            <div class="form-col cvv-field">
                <label>CVV</label>
                <input 
                    type="text" 
                    id="security-code" 
                    placeholder="CVV" 
                    maxlength="4"
                    pattern="\d{3,4}"
                    required
                >
            </div>
        </div>

        <div class="form-row doc-row">
            <div class="form-col doc-type">
                <label>Tipo de Doc.</label>
                <select name="doc_type" id="doc_type" required>
                    <option value="CPF">CPF</option>
                    <option value="CNPJ">CNPJ</option>
                </select>
            </div>
        
            <div class="form-col doc-number">
                <label>Número do Documento</label>
                <input type="text" name="doc_number" id="doc_number" placeholder="Somente números" required>
            </div>
        </div>

        <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" id="user_email" placeholder="Seu email" required>
        </div>

        <div class="form-group">
            <label>Número de Parcelas</label>
            <select name="installments" id="installments" required>
                <option value="">Carregando parcelas...</option>
            </select>
        </div>

        <input type="hidden" name="description" value="Inscrição Desafio 200k">
        <input type="hidden" name="item_description" value="Categoria Solo 200k">
        <input type="hidden" name="token" id="token">
        <button type="submit">Finalizar Pagamento</button>

        <!--Início do selo -->
        <div class="cartoes" align="center">      
            <!--Selo do Mercado--->
            <div>
                <img src="https://ecmrun.com.br/static/img/seloseguro.png" style="width:60%; margin-top: 3px;">
            </div>
        </div>
        <!--Final do selo -->
        <p class="selo-text"></p>A sua segurança é nossa prioridade. Ao realizar pagamentos com cartão de crédito através do nosso aplicativo, garantimos que todas as informações fornecidas são protegidas e criptografadas. Utilizamos tecnologias avançadas para proteger seus dados contra fraudes e acessos não autorizados.</p>

    </form>

    <footer class="footer">
        <img src="/static/img/ecmdev02.png" alt="Logo ECM Run" class="footer-logo">
        <p class="footer-text">ECM Run - 2025, todos os direitos reservados</p>
        <p class="footer-text">Desenvolvido por: ECM Sistemas Developer</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // Inicializar o Mercado Pago
            const mp = new MercadoPago('APP_USR-10f5fc95-1316-42e6-b475-546bbbc67c00', {
                locale: 'pt-BR'
            });

            // Carregar valor do localStorage
            console.log('Valor no localStorage:', localStorage.getItem('valortotal'));
            const storedAmount = localStorage.getItem('valortotal') || '0.00';
            const amountElement = document.getElementById('transaction-amount');
            amountElement.textContent = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(storedAmount);
            


            // Adicionar listener para o checkbox
            const vlinscricao = parseFloat(localStorage.getItem('valoratual') || 0);
            const vltaxa = parseFloat(localStorage.getItem('valortaxa') || 0);
            const totalValue = parseFloat(localStorage.getItem('valortotal') || 0);

            const checkbox = document.getElementById('same-user-data');
            const cardHolderName = document.getElementById('card_holder_name');
            const docNumber = document.getElementById('doc_number');
            const userEmail = document.getElementById('user_email');
            const docType = document.getElementById('doc_type');

            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    // Preencher com dados do localStorage
                    const storedName = localStorage.getItem('user_name');
                    const storedCPF = localStorage.getItem('user_cpf');
                    const storedEmail = localStorage.getItem('user_email');
                    
                    console.log('Valor no localStorage:', localStorage.getItem('valortotal'));

                    if (storedName && storedCPF && storedEmail) {
                        cardHolderName.value = storedName;
                        docNumber.value = storedCPF;
                        userEmail.value = storedEmail;
                        
                        // Forçar CPF como tipo de documento
                        docType.value = 'CPF';
                        
                        // Desabilitar campos
                        cardHolderName.disabled = true;
                        docNumber.disabled = true;
                        userEmail.disabled = true;
                        docType.disabled = true;
                    } else {
                        alert('Dados da inscrição não encontrados. Por favor, preencha os campos manualmente.');
                        this.checked = false;
                    }
                } else {
                    // Limpar e habilitar campos
                    cardHolderName.value = '';
                    docNumber.value = '';
                    userEmail.value = '';
                    
                    cardHolderName.disabled = false;
                    docNumber.disabled = false;
                    userEmail.disabled = false;
                    docType.disabled = false;
                }
            });

            // Funções de validação de documentos
            function validateCPF(cpf) {
                cpf = cpf.replace(/\D/g, '');
                if (cpf.length !== 11) return false;
                if (/^(\d)\1{10}$/.test(cpf)) return false;
                
                let sum = 0;
                for (let i = 0; i < 9; i++) {
                    sum += parseInt(cpf.charAt(i)) * (10 - i);
                }
                let rev = 11 - (sum % 11);
                if (rev === 10 || rev === 11) rev = 0;
                if (rev !== parseInt(cpf.charAt(9))) return false;
                
                sum = 0;
                for (let i = 0; i < 10; i++) {
                    sum += parseInt(cpf.charAt(i)) * (11 - i);
                }
                rev = 11 - (sum % 11);
                if (rev === 10 || rev === 11) rev = 0;
                if (rev !== parseInt(cpf.charAt(10))) return false;
                
                return true;
            }

            function validateCNPJ(cnpj) {
                cnpj = cnpj.replace(/\D/g, '');
                if (cnpj.length !== 14) return false;
                if (/^(\d)\1{13}$/.test(cnpj)) return false;
                
                let size = cnpj.length - 2;
                let numbers = cnpj.substring(0, size);
                let digits = cnpj.substring(size);
                let sum = 0;
                let pos = size - 7;
                
                for (let i = size; i >= 1; i--) {
                    sum += numbers.charAt(size - i) * pos--;
                    if (pos < 2) pos = 9;
                }
                
                let result = sum % 11 < 2 ? 0 : 11 - sum % 11;
                if (result !== parseInt(digits.charAt(0))) return false;
                
                size = size + 1;
                numbers = cnpj.substring(0, size);
                sum = 0;
                pos = size - 7;
                
                for (let i = size; i >= 1; i--) {
                    sum += numbers.charAt(size - i) * pos--;
                    if (pos < 2) pos = 9;
                }
                
                result = sum % 11 < 2 ? 0 : 11 - sum % 11;
                if (result !== parseInt(digits.charAt(1))) return false;
                
                return true;
            }

            // Máscaras para documentos
            function formatCPF(value) {
                value = value.slice(0, 11);
                return value
                    .replace(/\D/g, '')
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }

            function formatCNPJ(value) {
                value = value.slice(0, 14);
                return value
                    .replace(/\D/g, '')
                    .replace(/^(\d{2})(\d)/, '$1.$2')
                    .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
                    .replace(/\.(\d{3})(\d)/, '.$1/$2')
                    .replace(/(\d{4})(\d)/, '$1-$2');
            }

            // Event listener para máscara de documento
            const docNumberInput = document.getElementById('doc_number');
            const docTypeSelect = document.getElementById('doc_type');

            docNumberInput.addEventListener('input', function(e) {
                const docType = docTypeSelect.value;
                let value = e.target.value.replace(/\D/g, '');
                
                // Limitar o tamanho do valor baseado no tipo de documento
                if (docType === 'CPF') {
                    value = value.slice(0, 11);
                } else {
                    value = value.slice(0, 14);
                }
                
                if (docType === 'CPF') {
                    e.target.value = formatCPF(value);
                } else {
                    e.target.value = formatCNPJ(value);
                }
            });

            docNumberInput.addEventListener('blur', function(e) {
                const docType = docTypeSelect.value;
                const value = e.target.value.replace(/\D/g, '');
                let isValid = false;
                
                if (docType === 'CPF') {
                    isValid = validateCPF(value);
                } else {
                    isValid = validateCNPJ(value);
                }
                
                if (!isValid) {
                    e.target.classList.add('document-error');
                    e.target.setCustomValidity(`${docType} inválido`);
                } else {
                    e.target.classList.remove('document-error');
                    e.target.setCustomValidity('');
                }
            });

            docTypeSelect.addEventListener('change', function() {
                docNumberInput.value = '';
                docNumberInput.classList.remove('document-error');
                docNumberInput.setCustomValidity('');
            });

            // Função para identificar a bandeira do cartão
            function getCardType(cardNumber) {
                // Remover espaços e caracteres não numéricos
                cardNumber = cardNumber.replace(/\D/g, '');
                
                const patterns = {
                    visa: /^4/,
                    mastercard: /^(5[1-5]|2[2-7])/,
                    amex: /^3[47]/,
                    elo: /^(401178|401179|431274|438935|451416|457393|457631|457632|504175|627780|636297|636368|636369|(506699|5067[0-6]\d|50677[0-8])|(50900\d|5090[1-9]\d|509[1-9]\d{2})|65003[1-3]|(65003[5-9]|65004\d|65005[0-1])|(65040[5-9]|6504[1-3]\d)|(65048[5-9]|65049\d|6505[0-2]\d|65053[0-8])|(65054[1-9]|6505[5-8]\d|65059[0-8])|(65070\d|65071[0-8])|65072[0-7]|(65090[1-9]|65091\d|650920)|(65165[2-9]|6516[6-7]\d)|(65500\d|65501\d)|(65502[1-9]|6550[3-4]\d|65505[0-8]))/,
                    hipercard: /^(606282\d{10}(\d{3})?)|(3841\d{15})/,
                    diners: /^3(?:0[0-5]|[68][0-9])[0-9]{11}/
                };
                
                const mpBrandNames = {
                    visa: 'visa',
                    mastercard: 'master',
                    amex: 'amex',
                    elo: 'elo',
                    hipercard: 'hipercard',
                    diners: 'diners'
                };
                
                for (let [brand, pattern] of Object.entries(patterns)) {
                    if (pattern.test(cardNumber)) {
                        return mpBrandNames[brand];
                    }
                }
                
                return null;
            }

            // Função atualizada para obter parcelas
            async function getInstallments(amount, paymentMethodId) {
                try {
                    console.log('Calculando parcelas para:', { amount, paymentMethodId });
                    
                    const response = await mp.getInstallments({
                        amount: String(amount),
                        locale: 'pt-BR',
                        payment_method_id: paymentMethodId,
                    });

                    console.log('Resposta do getInstallments:', response);

                    if (response && response.length > 0) {
                        const installmentSelect = document.getElementById('installments');
                        installmentSelect.innerHTML = ''; // Limpa as opções existentes

                        response[0].payer_costs.forEach((cost) => {
                            const formattedAmount = new Intl.NumberFormat('pt-BR', {
                                style: 'currency',
                                currency: 'BRL'
                            }).format(cost.installment_amount);

                            const optionText = cost.recommended_message || 
                                `${cost.installments}x de ${formattedAmount}`;

                            const option = document.createElement('option');
                            option.value = cost.installments;
                            option.textContent = optionText;
                            installmentSelect.appendChild(option);
                        });
                    } else {
                        console.error('Nenhuma opção de parcelamento disponível');
                        document.getElementById('installments').innerHTML = '<option value="">Nenhuma parcela disponível</option>';
                    }
                } catch (error) {
                    console.error('Erro detalhado ao obter parcelas:', error);
                    document.getElementById('installments').innerHTML = '<option value="">Erro ao carregar parcelas</option>';
                }
            }

            // Atualização do listener do número do cartão
            document.getElementById('card-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                e.target.value = value.substring(0, 19);

                // Atualizar parcelas quando tiver 6 ou mais dígitos
                const cardNumber = value.replace(/\s/g, ''); // Remove espaços
                if (cardNumber.length >= 6) {
                    const bin = cardNumber.substring(0, 6); // Pega os primeiros 6 dígitos
                    const cardType = getCardType(cardNumber);
                    if (cardType) {
                        console.log('Bandeira identificada:', cardType);
                        console.log('BIN:', bin);
                        const storedAmount = localStorage.getItem('valortotal');
                        if (storedAmount) {
                            const amount = parseFloat(storedAmount);
                            if (!isNaN(amount)) {
                                // Chama getInstallments com o bin
                                mp.getInstallments({
                                    amount: String(amount),
                                    locale: 'pt-BR',
                                    payment_method_id: cardType,
                                    bin: bin
                                }).then((response) => {
                                    console.log('Resposta do getInstallments:', response);
                                    if (response && response.length > 0) {
                                        const installmentSelect = document.getElementById('installments');
                                        installmentSelect.innerHTML = ''; // Limpa as opções existentes

                                        response[0].payer_costs.forEach((cost) => {
                                            const formattedAmount = new Intl.NumberFormat('pt-BR', {
                                                style: 'currency',
                                                currency: 'BRL'
                                            }).format(cost.installment_amount);

                                            const optionText = cost.recommended_message || 
                                                `${cost.installments}x de ${formattedAmount}`;

                                            const option = document.createElement('option');
                                            option.value = cost.installments;
                                            option.textContent = optionText;
                                            installmentSelect.appendChild(option);
                                        });
                                    }
                                }).catch((error) => {
                                    console.error('Erro ao obter parcelas:', error);
                                    document.getElementById('installments').innerHTML = '<option value="">Erro ao carregar parcelas</option>';
                                });
                            }
                        }
                    }
                } else {
                    // Reseta o select de parcelas se não tiver números suficientes
                    document.getElementById('installments').innerHTML = '<option value="">Digite mais números do cartão...</option>';
                }
            });       

            // Máscara para data de validade
            document.getElementById('expiration-date').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value.substring(0, 5);
            });
        
            // Validação do nome completo
            document.querySelector('[name="card_holder_name"]').addEventListener('input', function(e) {
                const fullName = e.target.value.trim();
                const nameParts = fullName.split(' ').filter(part => part.length > 0);
                
                if (nameParts.length < 2) {
                    e.target.setCustomValidity('Por favor, insira nome e sobrenome completos');
                } else {
                    e.target.setCustomValidity('');
                }
            });


            function redirectToReceipt(paymentId) {
                try {
                    // Limpa dados do pagamento antes do redirecionamento
                    //sessionStorage.removeItem('paymentData');
                    //localStorage.removeItem('lastPaymentId');
                    
                    // Redireciona para a página de recibo
                    console.log('Redirecionando para:', `/comprovante/${paymentId}`);
                    window.location.replace(`/comprovante/${paymentId}`);
                } catch (error) {
                    console.error('Erro ao redirecionar:', error);
                    alert('Erro ao processar o pagamento. Por favor, entre em contato com o suporte.');
                }
            }

            // Manipulador do envio do formulário
            document.getElementById('payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const vlinscricao = parseFloat(localStorage.getItem('valoratual') || 0);
                const vltaxa = parseFloat(localStorage.getItem('valortaxa') || 0);
                const totalValue = parseFloat(localStorage.getItem('valortotal') || 0);

                try {
                    // Validação do nome completo
                    const fullName = document.querySelector('[name="card_holder_name"]').value.trim();
                    const nameParts = fullName.split(' ').filter(part => part.length > 0);
                    
                    if (nameParts.length < 2) {
                        throw new Error('Por favor, insira nome e sobrenome completos');
                    }
                    
                    const formapagto = localStorage.getItem('formaPagto');
                    const firstName = nameParts[0];
                    const lastName = nameParts.slice(1).join(' ');
                    
                    // Validação e obtenção do número do cartão
                    const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
                    const cardType = getCardType(cardNumber);
                    
                    if (!cardType) {
                        throw new Error('Cartão não reconhecido. Por favor, verifique o número do cartão');
                    }

                    console.log('Criando token do cartão...');

                    const userData = {
                        equipe: localStorage.getItem('equipe'),
                        apoio: localStorage.getItem('apoio'),
                        camiseta: localStorage.getItem('camiseta'),
                        nome_equipe: localStorage.getItem('nome_equipe'),
                        integrantes: localStorage.getItem('integrantes'),
                        valor_atual: vlinscricao,
                        valor_taxa: vltaxa,
                        valor_total: totalValue
                    };

                    const cardFormData = {
                        cardNumber: cardNumber,
                        cardExpirationMonth: document.getElementById('expiration-date').value.split('/')[0],
                        cardExpirationYear: '20' + document.getElementById('expiration-date').value.split('/')[1],
                        securityCode: document.getElementById('security-code').value,
                        cardholderName: fullName,
                        ...userData
                    };

                    console.log('Dados do cartão:', cardFormData);
                    
                    const cardToken = await mp.createCardToken(cardFormData);
                    console.log('Token gerado:', cardToken);

                    if (!cardToken.id) {
                        throw new Error('Não foi possível gerar o token do cartão');
                    }

                    // Obter número do documento sem máscara
                    const docNumber = document.querySelector('[name="doc_number"]').value.replace(/\D/g, '');

                    const paymentData = {
                        transaction_amount: Number(parseFloat(storedAmount).toFixed(2)),
                        //transaction_amount: parseFloat(storedAmount),
                        token: cardToken.id,
                        description: document.querySelector('[name="description"]').value,
                        installments: parseInt(document.querySelector('[name="installments"]').value),
                        payment_method_id: cardType,
                        payer: {
                            email: document.querySelector('[name="email"]').value,
                            identification: {
                                type: document.querySelector('[name="doc_type"]').value,
                                number: docNumber
                            },
                            first_name: firstName,
                            last_name: lastName
                        }
                    };

                    console.log('Enviando dados para o servidor:', paymentData);
                    
                    const response = await fetch('/process_payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Resposta do servidor:', data);

                    if (data.status === "approved") {                        
                        try {
                            // Fazer a chamada para verificar o pagamento
                            const verificationResponse = await fetch(`/lanca-pagamento-cartao/${data.id}`, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json'
                                }
                            });

                            if (!verificationResponse.ok) {
                                throw new Error('Erro ao verificar o pagamento');
                            }

                            const verificationData = await verificationResponse.json();
                            console.log('Verificação do pagamento:', verificationData);
                            
                            // Se tudo correr bem, mostra mensagem de sucesso
                            alert('Pagamento processado e verificado com sucesso!');

                            // Executa o redirecionamento
                            redirectToReceipt(data.id);

                        } catch (verificationError) {
                            console.error('Erro na verificação do pagamento:', verificationError);
                            alert('Pagamento aprovado, mas houve um erro na verificação e na finalização da inscrição. Mas fique tranquilo, sua inscrição está garantida, nosso suporte entrerá em contato pra finalizar seu cadastro, mas caso queira, você poderá entrar em contato com o suporte pelo WhatsApp (69)99925-7724 ou pelo e-mail adm@ecmrun.com.br. Desde já pedimos desconpas pelo ocorrido.');
                        }

                    } else {
                        alert(`Status do pagamento: ${data.status}`);
                    }
                } catch (error) {
                    console.error('Erro detalhado:', error);
                    let errorMessage = error.message;
                    if (errorMessage.includes('token')) {
                        errorMessage = 'Erro ao processar o cartão. Por favor, verifique os dados informados.';
                    }
                    alert(`Erro ao processar pagamento: ${errorMessage}`);
                }
            });
        });
    </script>
</body>
</html>
