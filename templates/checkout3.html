<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/static/css/checkout.css"/>
    <title>Pagamento com Cartão de Crédito</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script>
        window.MP_PUBLIC_KEY = "{{ mp_public_key }}";
    </script>
    <style>
        /* Estilos específicos para os Secure Fields */
        .mp-secure-field-container {
            width: 100%;
            height: 40px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            transition: border-color 0.2s;
            position: relative;
        }

        .mp-secure-field-container:focus-within {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .mp-secure-field-container.mp-form-row {
            display: flex;
            gap: 0;
        }

        .card-input-wrapper {
            position: relative;
            width: 100%;
        }

        .card-brand-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            height: 24px;
            width: auto;
            display: none;
            z-index: 10;
            pointer-events: none;
        }

        .mp-secure-field-container iframe {
            border: none !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Estilos para campos em linha (data e CVV) */
        .secure-fields-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .secure-field-col {
            flex: 1;
        }

        /* Estilos para feedback de validação */
        .field-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2) !important;
        }

        .field-valid {
            border-color: #28a745 !important;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2) !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Loading state para o botão */
        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-loading::after {
            content: "";
            width: 16px;
            height: 16px;
            margin-left: 10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsivo para Secure Fields */
        @media (max-width: 600px) {
            .mp-secure-field-container {
                height: 44px;
            }
        }

        // CSS adicional para melhorar a experiência do usuário
        const additionalStyles = `
        <style>
        /* Melhorias no formulário */
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .form-group input:disabled {
            background-color: #f5f5f5;
            opacity: 0.7;
        }

        /* Estados de validação para campos tradicionais */
        .document-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2) !important;
        }

        /* Loading no select de parcelas */
        #installments:disabled {
            background-color: #f8f9fa;
            opacity: 0.7;
        }

        /* Melhorias no modal de processamento */
        .processing-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .processing-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            min-width: 250px;
        }

        .processing-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .processing-text {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        /* Animações */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsividade adicional */
        @media (max-width: 768px) {
            .secure-fields-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .secure-field-col {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="https://ecmrun.com.br/static/img/ecmrunlogo1.png" alt="Logo" class="logo">
        <h1 class="header-title">Pagamento com Cartão de Crédito</h1>
    </div>

    <form id="payment-form">

        <div class="form-group">
            <div>Valor do Pagamento:</div>
            <div class="total-amount" id="transaction-amount">Carregando...</div>
        </div>

        <div class="form-group">
            <label class="checkbox-container">
                <input type="checkbox" id="same-user-data" name="same_user_data">
                <span class="checkbox-text">Utilizar os mesmos dados da inscrição para o pagamento</span>
            </label>
        </div>

        <div class="form-group">
            <label>Nome no Cartão</label>
            <input 
                type="text" 
                name="card_holder_name" 
                id="card_holder_name"
                placeholder="Nome completo" 
                required
                style="text-transform: uppercase;"
            >
        </div>

        <!-- Secure Field para Número do Cartão -->
        <div class="form-group">
            <label>Número do Cartão</label>
            <div class="card-input-wrapper">
                <div id="form-checkout__cardNumber" class="mp-secure-field-container"></div>
                <img id="card-brand-icon" src="" alt="Card brand" class="card-brand-icon">
            </div>
            <div id="cardNumber-error" class="error-message"></div>
        </div>

        <!-- Secure Fields para Data e CVV em linha -->
        <div class="secure-fields-row">
            <div class="secure-field-col">
                <label>Data de Validade</label>
                <div id="form-checkout__expirationDate" class="mp-secure-field-container"></div>
                <div id="expirationDate-error" class="error-message"></div>
            </div>
            
            <div class="secure-field-col">
                <label>CVV</label>
                <div id="form-checkout__securityCode" class="mp-secure-field-container"></div>
                <div id="securityCode-error" class="error-message"></div>
            </div>
        </div>

        <div class="form-row doc-row">
            <div class="form-col doc-type">
                <label>Tipo de Doc.</label>
                <select name="doc_type" id="doc_type" required>
                    <option value="CPF">CPF</option>
                    <option value="CNPJ">CNPJ</option>
                </select>
            </div>
        
            <div class="form-col doc-number">
                <label>Número do Documento</label>
                <input type="tel" id="doc_number" name="doc_number" class="form-control" 
                       placeholder="000.000.000-00" required inputmode="numeric">                
            </div>
        </div>

        <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" id="user_email" placeholder="Seu email" required>
        </div>

        <div class="form-group">
            <label>Número de Parcelas</label>
            <select name="installments" id="installments" required>
                <option value="">Carregando parcelas...</option>
            </select>
        </div>

        <input type="hidden" name="description" value="ECM RUN Inscrição Evento">
        <input type="hidden" name="item_description" value="Inscrição Corrida">
        <button type="submit" id="submit-button">Finalizar Pagamento</button>

        <!--Início do selo -->
        <div class="selo-container">
            <div class="selo-imagem">
                <img src="https://ecmrun.com.br/static/img/seloseguro.png" alt="Selo de Segurança">
            </div>
            <div class="selo-texto-container">
                <p>A sua segurança é nossa prioridade. Ao realizar pagamentos com cartão de crédito através do nosso aplicativo, garantimos que todas as informações fornecidas são protegidas e criptografadas. Utilizamos tecnologias avançadas para proteger seus dados contra fraudes e acessos não autorizados.</p>
            </div>
        </div>

    </form>

    <footer class="footer">
        <p class="bible-verse">"Tudo posso naquele que me fortalece." - Filipenses 4:13</p>
        <img src="/static/img/ecmdev02.png" alt="Logo ECM Run" class="footer-logo">
        <p class="footer-text">ECM RUN Esports - todos os direitos reservados</p>
        <p class="footer-text">Desenvolvido por: ECM Sistemas Developer</p>
    </footer>

    <!-- Modal de processamento -->
    <div id="processing-modal" class="processing-modal">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <div class="processing-text">Processando Pagamento...</div>
        </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar o Mercado Pago
    const mp = new MercadoPago(window.MP_PUBLIC_KEY, {
        locale: 'pt-BR'
    });

    // Gerar ou recuperar device ID
    let deviceId = sessionStorage.getItem('mp_device_id');
    if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('mp_device_id', deviceId);
    }
    console.log('Device ID:', deviceId);

    // Variáveis para controle
    let cardForm;
    let currentPaymentMethod;
    let isFormValid = false;

    // Configurar Secure Fields
    const cardFormConfig = {
        id: "form-checkout",
        cardholderName: {
            id: "card_holder_name",
            placeholder: "Nome completo"
        },
        cardholderEmail: {
            id: "user_email"
        },
        cardNumber: {
            id: "form-checkout__cardNumber",
            placeholder: "0000 0000 0000 0000"
        },
        expirationDate: {
            id: "form-checkout__expirationDate",
            placeholder: "MM/AA"
        },
        securityCode: {
            id: "form-checkout__securityCode",
            placeholder: "123"
        },
        installments: {
            id: "installments",
            placeholder: "Parcelas"
        },
        identificationType: {
            id: "doc_type"
        },
        identificationNumber: {
            id: "doc_number"
        },
        callbacks: {
            onFormMounted: error => {
                if (error) {
                    console.error('Erro ao montar o formulário:', error);
                    return;
                }
                console.log('Formulário Secure Fields montado com sucesso');
            },
            
            onSubmit: event => {
                event.preventDefault();
                handleFormSubmit();
            },
            
            onFetching: (resource) => {
                console.log("Buscando recurso: ", resource);
                
                // Mostrar loading nos elementos apropriados
                const loadingElements = {
                    'installments': document.getElementById('installments'),
                    'payment_methods': document.getElementById('installments')
                };
                
                if (loadingElements[resource]) {
                    loadingElements[resource].innerHTML = '<option value="">Carregando...</option>';
                }
            },
            
            onValidityChange: (error, field) => {
                const fieldContainer = document.getElementById(`form-checkout__${field}`);
                const errorElement = document.getElementById(`${field}-error`);
                
                if (fieldContainer) {
                    fieldContainer.classList.remove('field-error', 'field-valid');
                    
                    if (error) {
                        fieldContainer.classList.add('field-error');
                        if (errorElement) {
                            errorElement.textContent = error.message || 'Campo inválido';
                            errorElement.classList.add('show');
                        }
                    } else {
                        fieldContainer.classList.add('field-valid');
                        if (errorElement) {
                            errorElement.classList.remove('show');
                        }
                    }
                }
                
                updateFormValidation();
            },
            
            onCardTokenReceived: (error, token) => {
                if (error) {
                    console.error('Erro ao gerar token:', error);
                    showError('Erro ao processar dados do cartão: ' + error.message);
                    return;
                }
                
                console.log('Token recebido:', token);
                processPayment(token);
            },
            
            onInstallmentsReceived: (error, installments) => {
                if (error) {
                    console.error('Erro ao obter parcelas:', error);
                    document.getElementById('installments').innerHTML = 
                        '<option value="">Erro ao carregar parcelas</option>';
                    return;
                }
                
                console.log('Parcelas recebidas:', installments);
                updateInstallmentsSelect(installments);
            },
            
            onPaymentMethodsReceived: (error, paymentMethods) => {
                if (error) {
                    console.error('Erro ao obter métodos de pagamento:', error);
                    return;
                }
                
                console.log('Métodos de pagamento:', paymentMethods);
                if (paymentMethods && paymentMethods.results && paymentMethods.results.length > 0) {
                    currentPaymentMethod = paymentMethods.results[0];
                    updateCardBrandIcon(currentPaymentMethod.id);
                }
            }
        }
    };

    // Inicializar o CardForm
    cardForm = mp.cardForm(cardFormConfig);

    // Função para atualizar ícone da bandeira
    function updateCardBrandIcon(paymentMethodId) {
        const iconMap = {
            'visa': 'https://ecmrun.com.br/static/img/visa.png',
            'master': 'https://ecmrun.com.br/static/img/mastercard.png',
            'amex': 'https://ecmrun.com.br/static/img/amex.png',
            'elo': 'https://ecmrun.com.br/static/img/elo.png',
            'hipercard': 'https://ecmrun.com.br/static/img/hipercard.png',
            'diners': 'https://ecmrun.com.br/static/img/diners.png'
        };
        
        const cardBrandIcon = document.getElementById('card-brand-icon');
        if (iconMap[paymentMethodId]) {
            cardBrandIcon.src = iconMap[paymentMethodId];
            cardBrandIcon.style.display = 'block';
        } else {
            cardBrandIcon.style.display = 'none';
        }
    }

    // Função para atualizar select de parcelas
    function updateInstallmentsSelect(installments) {
        const installmentSelect = document.getElementById('installments');
        installmentSelect.innerHTML = '';
        
        if (installments && installments.payer_costs) {
            installments.payer_costs.forEach((cost) => {
                const formattedAmount = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(cost.installment_amount);

                const optionText = cost.recommended_message || 
                    `${cost.installments}x de ${formattedAmount}`;

                const option = document.createElement('option');
                option.value = cost.installments;
                option.textContent = optionText;
                installmentSelect.appendChild(option);
            });
        } else {
            installmentSelect.innerHTML = '<option value="">Nenhuma parcela disponível</option>';
        }
    }

    // Função para validar formulário
    function updateFormValidation() {
        const requiredFields = ['card_holder_name', 'user_email', 'doc_number'];
        const selectFields = ['doc_type', 'installments'];
        
        let allValid = true;
        
        // Verificar campos de texto
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                allValid = false;
            }
        });
        
        // Verificar selects
        selectFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value) {
                allValid = false;
            }
        });
        
        // Verificar se há erros nos Secure Fields
        const errorElements = document.querySelectorAll('.field-error');
        if (errorElements.length > 0) {
            allValid = false;
        }
        
        isFormValid = allValid;
        
        const submitButton = document.getElementById('submit-button');
        submitButton.disabled = !allValid;
        
        if (allValid) {
            submitButton.classList.remove('btn-loading');
        }
    }

    // Carregar dados iniciais
    function loadInitialData() {
        const storedAmount = localStorage.getItem('valortotal') || '0.00';
        const amountElement = document.getElementById('transaction-amount');
        amountElement.textContent = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(storedAmount);
        
        const idEvento = localStorage.getItem('id_evento');
        console.log('ID do Evento recuperado:', idEvento);

        if (!idEvento) {
            console.error('ID do evento não encontrado no localStorage');
            alert('Erro: ID do evento não encontrado. Redirecionando para a página anterior.');
            window.history.back();
            return;
        }
    }

    // Configurar checkbox para usar dados da inscrição
    function setupUserDataCheckbox() {
        const checkbox = document.getElementById('same-user-data');
        const cardHolderName = document.getElementById('card_holder_name');
        const docNumber = document.getElementById('doc_number');
        const userEmail = document.getElementById('user_email');
        const docType = document.getElementById('doc_type');

        checkbox.addEventListener('change', function() {
            if (this.checked) {
                const storedName = localStorage.getItem('user_name');
                const storedCPF = localStorage.getItem('user_cpf');
                const storedEmail = localStorage.getItem('user_email');
                
                if (storedName && storedCPF && storedEmail) {
                    cardHolderName.value = storedName.toUpperCase();
                    docNumber.value = storedCPF;
                    userEmail.value = storedEmail;
                    docType.value = 'CPF';
                    
                    cardHolderName.disabled = true;
                    docNumber.disabled = true;
                    userEmail.disabled = true;
                    docType.disabled = true;
                    
                    updateFormValidation();
                } else {
                    alert('Dados da inscrição não encontrados. Por favor, preencha os campos manualmente.');
                    this.checked = false;
                }
            } else {
                cardHolderName.value = '';
                docNumber.value = '';
                userEmail.value = '';
                
                cardHolderName.disabled = false;
                docNumber.disabled = false;
                userEmail.disabled = false;
                docType.disabled = false;
                
                updateFormValidation();
            }
        });
    }

    // Configurar máscara de documento
    function setupDocumentMask() {
        const docNumberInput = document.getElementById('doc_number');
        const docTypeSelect = document.getElementById('doc_type');

        function formatCPF(value) {
            return value.slice(0, 11)
                .replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }

        function formatCNPJ(value) {
            return value.slice(0, 14)
                .replace(/\D/g, '')
                .replace(/^(\d{2})(\d)/, '$1.$2')
                .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
                .replace(/\.(\d{3})(\d)/, '.$1/$2')
                .replace(/(\d{4})(\d)/, '$1-$2');
        }

        function validateCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let rev = 11 - (sum % 11);
            if (rev === 10 || rev === 11) rev = 0;
            if (rev !== parseInt(cpf.charAt(9))) return false;
            
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cpf.charAt(i)) * (11 - i);
            }
            rev = 11 - (sum % 11);
            if (rev === 10 || rev === 11) rev = 0;
            return rev === parseInt(cpf.charAt(10));
        }

        function validateCNPJ(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length !== 14 || /^(\d)\1{13}$/.test(cnpj)) return false;
            
            let size = cnpj.length - 2;
            let numbers = cnpj.substring(0, size);
            let digits = cnpj.substring(size);
            let sum = 0;
            let pos = size - 7;
            
            for (let i = size; i >= 1; i--) {
                sum += numbers.charAt(size - i) * pos--;
                if (pos < 2) pos = 9;
            }
            
            let result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result !== parseInt(digits.charAt(0))) return false;
            
            size = size + 1;
            numbers = cnpj.substring(0, size);
            sum = 0;
            pos = size - 7;
            
            for (let i = size; i >= 1; i--) {
                sum += numbers.charAt(size - i) * pos--;
                if (pos < 2) pos = 9;
            }
            
            result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            return result === parseInt(digits.charAt(1));
        }

        docNumberInput.addEventListener('input', function(e) {
            const docType = docTypeSelect.value;
            let value = e.target.value.replace(/\D/g, '');
            
            if (docType === 'CPF') {
                e.target.value = formatCPF(value);
            } else {
                e.target.value = formatCNPJ(value);
            }
            
            updateFormValidation();
        });

        docNumberInput.addEventListener('blur', function(e) {
            const docType = docTypeSelect.value;
            const value = e.target.value.replace(/\D/g, '');
            let isValid = false;
            
            if (docType === 'CPF') {
                isValid = validateCPF(value);
            } else {
                isValid = validateCNPJ(value);
            }
            
            if (!isValid && value.length > 0) {
                e.target.classList.add('document-error');
                e.target.setCustomValidity(`${docType} inválido`);
            } else {
                e.target.classList.remove('document-error');
                e.target.setCustomValidity('');
            }
            
            updateFormValidation();
        });

        docTypeSelect.addEventListener('change', function() {
            docNumberInput.value = '';
            docNumberInput.classList.remove('document-error');
            docNumberInput.setCustomValidity('');
            updateFormValidation();
        });
    }

    // Função para mostrar erros
    function showError(message) {
        alert('Erro: ' + message);
        
        const submitButton = document.getElementById('submit-button');
        submitButton.classList.remove('btn-loading');
        submitButton.disabled = false;
        submitButton.textContent = 'Finalizar Pagamento';
    }

    // Função para processar pagamento
    async function processPayment(token) {
        try {
            console.log('Processando pagamento com token:', token);
            
            const vlinscricao = parseFloat(localStorage.getItem('valoratual') || 0);
            const vltaxa = parseFloat(localStorage.getItem('valortaxa') || 0);
            const totalValue = parseFloat(localStorage.getItem('valortotal') || 0);
            const idEvento = localStorage.getItem('id_evento');
            
            const docNumber = document.getElementById('doc_number').value.replace(/\D/g, '');
            const docType = document.getElementById('doc_type').value;
            const email = document.getElementById('user_email').value;
            const cardHolderName = document.getElementById('card_holder_name').value;
            const installments = parseInt(document.getElementById('installments').value);
            
            const nameParts = cardHolderName.trim().split(' ').filter(part => part.length > 0);
            const firstName = nameParts[0];
            const lastName = nameParts.slice(1).join(' ');
            
            const paymentData = {
                transaction_amount: Number(totalValue.toFixed(2)),
                token: token,
                description: "ECM RUN Inscrição",
                installments: installments,
                payment_method_id: currentPaymentMethod ? currentPaymentMethod.id : 'visa',
                payer: {
                    email: email,
                    identification: {
                        type: docType,
                        number: docNumber
                    },
                    first_name: firstName,
                    last_name: lastName
                },
                CPF: docNumber,
                valor_atual: vlinscricao,
                valor_taxa: vltaxa,
                valor_total: totalValue,
                device_id: deviceId,
                inscrito_cpf: localStorage.getItem('user_cpf'),
                inscrito_name: localStorage.getItem('user_name'),
                inscrito_email: localStorage.getItem('user_email'),
                id_evento: idEvento
            };

            console.log('Enviando dados para o servidor...');
            
            const response = await fetch('/process_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(paymentData)
            });

            const responseData = await response.json();
            console.log('Resposta do servidor:', responseData);

            if (!response.ok) {
                let errorMessage = 'Erro ao processar pagamento';
                
                if (responseData.error) {
                    errorMessage = responseData.error;
                }
                
                if (responseData.details) {
                    console.error('Detalhes do erro:', responseData.details);
                }
                
                throw new Error(errorMessage);
            }

            if (responseData.status === "approved") {
                alert('Pagamento aprovado com sucesso!');
                await redirectToReceipt(responseData.id);
            } else {
                let message = 'Pagamento não foi aprovado.';
                if (responseData.status === 'pending') {
                    message = 'Pagamento está pendente de aprovação.';
                } else if (responseData.status === 'rejected') {
                    message = 'Pagamento foi rejeitado.';
                }
                
                if (responseData.status_detail) {
                    message += ` Motivo: ${responseData.status_detail}`;
                }
                
                alert(message);
            }

        } catch (error) {
            console.error('Erro ao processar pagamento:', error);
            showError(error.message);
        }
    }

    // Função para redirecionar para comprovante
    async function redirectToReceipt(paymentId) {
        try {
            console.log('Atualizando ID do pagamento...');
            
            const cpf = localStorage.getItem('user_cpf');
            const idEvento = localStorage.getItem('id_evento');
            
            if (!cpf || !idEvento) {
                throw new Error('CPF ou ID do evento não encontrados');
            }
            
            const updateResponse = await fetch(`/atualiza-idpagamento/${cpf}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    payment_id: paymentId,
                    id_evento: idEvento
                })
            });
            
            if (!updateResponse.ok) {
                throw new Error('Erro ao atualizar ID do pagamento');
            }
            
            console.log('Verificando status do pagamento...');
            
            const verificationResponse = await fetch(`/verificar-pagamento/${paymentId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (!verificationResponse.ok) {
                throw new Error('Erro na verificação do pagamento');
            }
            
            const verificationData = await verificationResponse.json();
            console.log('Resultado da verificação:', verificationData);
            
            if (verificationData.success && verificationData.status === 'approved') {
                console.log('Pagamento verificado e aprovado. Redirecionando para comprovante...');
                window.location.replace(`/comprovante/${paymentId}`);
            } else {
                throw new Error('Pagamento não aprovado ou erro na verificação');
            }
            
        } catch (error) {
            console.error('Erro ao processar pagamento:', error);
            alert('Erro ao processar o pagamento. Por favor, entre em contato com o suporte.');
        }
    }

    // Função para manipular envio do formulário
    function handleFormSubmit() {
        if (!isFormValid) {
            alert('Por favor, preencha todos os campos corretamente.');
            return;
        }

        // Validar nome completo
        const fullName = document.getElementById('card_holder_name').value.trim();
        const nameParts = fullName.split(' ').filter(part => part.length > 0);
        
        if (nameParts.length < 2) {
            alert('Por favor, insira nome e sobrenome completos');
            return;
        }

        // Validar documento
        const docNumber = document.getElementById('doc_number').value.replace(/\D/g, '');
        const docType = document.getElementById('doc_type').value;
        
        let isValidDoc = false;
        if (docType === 'CPF') {
            isValidDoc = validateCPF(docNumber);
        } else {
            isValidDoc = validateCNPJ(docNumber);
        }
        
        if (!isValidDoc) {
            alert(`${docType} inválido. Por favor, verifique o número informado.`);
            return;
        }

        // Validar email
        const email = document.getElementById('user_email').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Por favor, insira um email válido.');
            return;
        }

        // Mostrar estado de loading
        const submitButton = document.getElementById('submit-button');
        submitButton.classList.add('btn-loading');
        submitButton.disabled = true;
        submitButton.textContent = 'Processando...';

        // Mostrar modal de processamento se existir
        const processingModal = document.getElementById('processing-modal');
        if (processingModal) {
            processingModal.style.display = 'flex';
        }

        try {
            // O CardForm do Mercado Pago irá automaticamente gerar o token
            // e chamar o callback onCardTokenReceived
            console.log('Iniciando processo de geração de token...');
        } catch (error) {
            console.error('Erro ao iniciar processo de pagamento:', error);
            showError(error.message);
            
            // Esconder modal de processamento
            if (processingModal) {
                processingModal.style.display = 'none';
            }
        }
    }

    // Função auxiliar para validação de CPF (reutilizada)
    function validateCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
        
        let sum = 0;
        for (let i = 0; i < 9; i++) {
            sum += parseInt(cpf.charAt(i)) * (10 - i);
        }
        let rev = 11 - (sum % 11);
        if (rev === 10 || rev === 11) rev = 0;
        if (rev !== parseInt(cpf.charAt(9))) return false;
        
        sum = 0;
        for (let i = 0; i < 10; i++) {
            sum += parseInt(cpf.charAt(i)) * (11 - i);
        }
        rev = 11 - (sum % 11);
        if (rev === 10 || rev === 11) rev = 0;
        return rev === parseInt(cpf.charAt(10));
    }

    // Função auxiliar para validação de CNPJ (reutilizada)
    function validateCNPJ(cnpj) {
        cnpj = cnpj.replace(/\D/g, '');
        if (cnpj.length !== 14 || /^(\d)\1{13}$/.test(cnpj)) return false;
        
        let size = cnpj.length - 2;
        let numbers = cnpj.substring(0, size);
        let digits = cnpj.substring(size);
        let sum = 0;
        let pos = size - 7;
        
        for (let i = size; i >= 1; i--) {
            sum += numbers.charAt(size - i) * pos--;
            if (pos < 2) pos = 9;
        }
        
        let result = sum % 11 < 2 ? 0 : 11 - sum % 11;
        if (result !== parseInt(digits.charAt(0))) return false;
        
        size = size + 1;
        numbers = cnpj.substring(0, size);
        sum = 0;
        pos = size - 7;
        
        for (let i = size; i >= 1; i--) {
            sum += numbers.charAt(size - i) * pos--;
            if (pos < 2) pos = 9;
        }
        
        result = sum % 11 < 2 ? 0 : 11 - sum % 11;
        return result === parseInt(digits.charAt(1));
    }

    // Adicionar listeners para validação em tempo real
    function setupRealTimeValidation() {
        // Validação do nome
        document.getElementById('card_holder_name').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
            updateFormValidation();
        });

        // Validação do email
        document.getElementById('user_email').addEventListener('input', function(e) {
            updateFormValidation();
        });

        // Validação das parcelas
        document.getElementById('installments').addEventListener('change', function(e) {
            updateFormValidation();
            updateTotalAmountDisplay();
        });
    }

    // Função para atualizar o display do valor total com juros
    function updateTotalAmountDisplay() {
        const installmentSelect = document.getElementById('installments');
        const selectedInstallments = installmentSelect.value;
        const amountElement = document.getElementById('transaction-amount');
        
        if (selectedInstallments && currentPaymentMethod) {
            // Se tivermos dados de parcelas, calcular o valor com juros
            const baseAmount = parseFloat(localStorage.getItem('valortotal') || 0);
            
            // Para parcelas à vista (1x), geralmente não há juros
            if (parseInt(selectedInstallments) === 1) {
                amountElement.textContent = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(baseAmount);
            } else {
                // Para outras parcelas, manter o valor original até ter dados precisos
                // O Mercado Pago fornecerá o valor exato via callback onInstallmentsReceived
                amountElement.textContent = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(baseAmount);
            }
        }
    }

    // Event listener para o formulário
    document.getElementById('payment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit();
    });

    // Inicializar todas as funcionalidades
    loadInitialData();
    setupUserDataCheckbox();
    setupDocumentMask();
    setupRealTimeValidation();

    // Listener para detecção de mudanças nos campos para atualizar validação
    const formFields = ['card_holder_name', 'user_email', 'doc_number', 'doc_type', 'installments'];
    formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', updateFormValidation);
            field.addEventListener('input', updateFormValidation);
        }
    });

    // Atualização inicial da validação
    setTimeout(() => {
        updateFormValidation();
    }, 1000);

    console.log('Checkout com Secure Fields inicializado com sucesso');
});