<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://ecmrun.com.br/static/img/logo_arealslope.jpeg">
    <link rel="stylesheet" type="text/css" href="/static/css/inscricao_evento.css"/>
    <title>Inscrição - {{ evento.titulo }}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
</head>
<body>
    <!-- Widget de Valores - Desktop -->
    <div class="valores-widget-desktop" id="valoresWidgetDesktop">
        <div class="widget-title">Valores da Inscrição</div>
        <div class="widget-lote" id="widgetLoteDesktop">Carregando...</div>
        <div class="valor-row">
            <span>Inscrição:</span>
            <span id="widgetValorInscricaoDesktop">R$ 0,00</span>
        </div>
        <div class="valor-row">
            <span>Taxa de Serviço:</span>
            <span id="widgetValorTaxaDesktop">R$ 0,00</span>
        </div>
        <div class="valor-row total">
            <span>Total a Pagar:</span>
            <span id="widgetValorTotalDesktop">R$ 0,00</span>
        </div>
    </div>

    <!-- Widget de Valores - Mobile -->
    <div class="valores-widget-mobile" id="valoresWidgetMobile">
        <div class="widget-content">
            <div class="widget-info">
                <div class="widget-lote" id="widgetLoteMobile">Carregando...</div>
                <div class="widget-title">Inscrição do Evento</div>
                <div class="valor-detalhes">
                    Inscrição: <span id="widgetValorInscricaoMobile">R$ 0,00</span> + 
                    Taxa: <span id="widgetValorTaxaMobile">R$ 0,00</span>
                </div>
            </div>
            <div class="widget-total">
                <div class="total-label">Total</div>
                <div class="total-valor" id="widgetValorTotalMobile">R$ 0,00</div>
            </div>
        </div>
    </div>

    <!-- Timer countdown -->
    <div class="timer-container">
        ⏰ Tempo restante: <span id="timer">15:00</span>
    </div>

    <div class="container">
        <!-- Header com informações do evento -->
        <div class="event-header">
            <h1 class="event-title" id="eventoTitulo">Carregando...</h1>
            <!-- <h1 class="event-title">{{ evento.titulo }} </h1>  -->
            <div class="lote-info" id="loteInfo">Carregando...</div>
        </div>

        <div class="form-container">
            <h2 class="form-title">Dados para Inscrição</h2>
            
            <form id="inscricaoForm">
                <!-- CPF -->
                <div class="form-group">
                    <label for="cpf">CPF <span class="required">*</span></label>
                    <input type="text" id="cpf" name="cpf" required maxlength="14" inputmode="numeric">
                    <div class="error-message" id="cpfError"></div>
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label for="email">E-mail <span class="required">*</span></label>
                    <input type="email" id="email" name="email" required>
                    <div class="error-message" id="emailError"></div>
                </div>

                <!-- Nome e Sobrenome -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome">Nome <span class="required">*</span></label>
                        <input type="text" id="nome" name="nome" required maxlength="25">
                        <div class="error-message" id="nomeError"></div>
                    </div>
                    <div class="form-group">
                        <label for="sobrenome">Sobrenome <span class="required">*</span></label>
                        <input type="text" id="sobrenome" name="sobrenome" required maxlength="150">
                        <div class="error-message" id="sobrenomeError"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <!-- Data de Nascimento -->
                    <div class="form-group">
                        <label for="dataNascimento">Data de Nascimento <span class="required">*</span></label>
                        <input type="text" id="dataNascimento" name="dataNascimento" required placeholder="dd/mm/aaaa" inputmode="numeric">
                        <div class="error-message" id="dataNascimentoError"></div>
                    </div>
                    <!-- Celular -->
                    <div class="form-group">
                        <label for="celular">Celular <span class="required">*</span></label>
                        <input type="text" id="celular" name="celular" required  inputmode="numeric" >
                        <div class="error-message" id="celularError"></div>
                    </div>
                </div>

                <!-- Sexo -->
                <div class="form-group">
                    <label>Sexo <span class="required">*</span></label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="radio" id="masculino" name="sexo" value="M" required>
                            <label for="masculino">Masculino</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="feminino" name="sexo" value="F" required>
                            <label for="feminino">Feminino</label>
                        </div>
                    </div>
                    <div class="error-message" id="sexoError"></div>
                </div>

                <!-- Tamanho da Camiseta -->
                <div class="form-group">
                    <label>Tamanho da Camiseta <span class="required">*</span></label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="radio" id="camisetaPP" name="camiseta" value="PP" required>
                            <label for="camisetaPP">PP</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="camisetaP" name="camiseta" value="P" required>
                            <label for="camisetaP">P</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="camisetaM" name="camiseta" value="M" required>
                            <label for="camisetaM">M</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="camisetaG" name="camiseta" value="G" required>
                            <label for="camisetaG">G</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="camisetaGG" name="camiseta" value="GG" required>
                            <label for="camisetaGG">GG</label>
                        </div>
                    </div>
                    <div class="error-message" id="camisetaError"></div>
                </div>

                <!-- Estado e Cidade -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="estado">Estado <span class="required">*</span></label>
                        <select id="estado" name="estado" required>
                            <option value="">Selecione um estado</option>
                        </select>
                        <div class="error-message" id="estadoError"></div>
                    </div>
                    <div class="form-group">
                        <label for="cidade">Cidade <span class="required">*</span></label>
                        <select id="cidade" name="cidade" required disabled>
                            <option value="">Primeiro selecione um estado</option>
                        </select>
                        <div class="error-message" id="cidadeError"></div>
                    </div>
                </div>

                <!-- Nome Peito -->
                <div class="form-group">
                    <label for="nomepeito">Nome para Nº Peito <span class="optional">(opcional)</span></label>
                    <input type="text" id="nomepeito" name="nomepeito" maxlength="25">
                </div>

                <!-- Equipe -->
                <div class="form-group">
                    <label for="equipe">Equipe de corrida <span class="optional">(opcional)</span></label>
                    <input type="text" id="equipe" name="equipe" maxlength="45">
                </div>

                <div class="form-row">
                    <!-- Telefone de Emergência -->
                    <div class="form-group">
                        <label for="telEmergencia">Telefone de Emergência <span class="optional">(opcional)</span></label>
                        <input type="text" id="telEmergencia" name="telEmergencia"  inputmode="numeric" >
                    </div>
                    <!-- Contato de Emergência -->
                    <div class="form-group">
                        <label for="contEmergencia">Contato de Emergência <span class="optional">(opcional)</span></label>
                        <input type="text" id="contEmergencia" name="contEmergencia" maxlength="45">
                    </div>
                </div>

                <!-- Cupom -->
                <!-- ocultei temporariament no CSS prix a linha 118 do arquivo CSS -->
                <div class="form-group">
                    <label for="cupom" class="cupom-label">Cupom de Desconto</label>
                    <input type="text" id="cupom" name="cupom" maxlength="10">
                </div>

                <!-- Valores da Inscrição -->
                <div class="valores-container" id="valoresContainer">
                    <div class="valores-title">Valores da Inscrição</div>
                    <div class="valor-item">
                        <span>Valor da Inscrição:</span>
                        <span id="valorInscricao">R$ 0,00</span>
                    </div>
                    <div class="valor-item">
                        <span>Taxa de Serviço:</span>
                        <span id="valorTaxa">R$ 0,00</span>
                    </div>
                    <div class="valor-item valor-total">
                        <span>Total a Pagar:</span>
                        <span id="valorTotal">R$ 0,00</span>
                    </div>
                </div>

                <!-- Forma de Pagamento -->
                <div class="form-group">
                    <label>Forma de Pagamento <span class="required">*</span></label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="radio" id="pix" name="formaPagamento" value="PIX" required>
                            <label for="pix">Pix</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="cartao" name="formaPagamento" value="CARTAO" required>
                            <label for="cartao">Cartão de Crédito</label>
                        </div>
                    </div>
                    <div class="error-message" id="formaPagamentoError"></div>
                </div>

                <!-- Termo de Responsabilidade -->
                <div class="form-group termo-container">
                    <label>Termo de Responsabilidade <span class="required">*</span></label>
                    <div class="termo-texto">
                        Declaro que:
                        <br><br>
                        - Disputo esta prova por minha livre e espontânea vontade, isentando de quaisquer responsabilidades os organizadores e as empresas envolvidas no evento, em meu nome e de meus herdeiros;
                        <br><br>
                        - Estou liberado por meu médico para participar e estou treinado apropriadamente para a prova.
                        <br><br>
                        - Isento os organizadores e as empresas envolvidas no evento, de quaisquer responsabilidades sobre os objetos deixados por mim no guarda-volumes ou locais indicados pela organização do evento;
                        <br><br>
                        - Estou ciente que o valor pago para inscrição não será devolvido em caso de cancelamento ou não participação no evento, bem como não são aceitas substituições/troca de participantes de uma inscrição e que caso meu pedido seja atendido será considerado como exceção;
                        <br><br>
                        - Aceito que as inscrições podem encerrar-se a qualquer momento e para garantir minha inscrição é necessário o pagamento da mesma.
                        <br><br>
                        - É de minha responsabilidade obter todas as informações sobre o evento, tais como: data, local e horário.
                        <br><br>
                        - Autorizo por este meio a utilização por parte do organizador, patrocinadores de qualquer dado, fotografia, filme ou outra gravação contendo imagens de minha participação neste evento em qualquer mídia seja impressa ou eletrônica, incluindo na Internet, para qualquer fim e por tempo indeterminado.
                        <br><br>
                        - Autorizo recebimento de e-mails e/ou SMS da ECMRUN TICKECTS e seus parceiros divulgando informações, notícias e serviços do segmento.
                        <br><br>
                        - Na realização da inscrição para terceiros, tenho a autorização deste participante e que me responsabilizo pela legitimidade de seus dados que estou fornecendo e que o mesmo tem total ciência desta declaração e do REGULAMENTO do evento.
                        <br><br>
                        - Estou totalmente ciente e concordo com o REGULAMENTO do Evento.
                        <br><br>
                        - Declaro que as informações e dados fornecidos são verdadeiros, completos e correspondem à minha real situação. Estou ciente de que fornecer informações falsas ou incompletas poderá acarretar a minha desclassificação da prova, além das sanções legais cabíveis. Assim, assumo total responsabilidade pela veracidade e exatidão dos dados informados, isentando a organização do evento de qualquer responsabilidade decorrente de informações incorretas ou fraudulentas.
                    </div>
                    
                    <div class="termo-aceite">
                        <input type="checkbox" id="termoAceite" name="termoAceite" required>
                        <label for="termoAceite">Eu aceito os termos acima <span class="required">*</span></label>
                    </div>
                    <div class="error-message" id="termoAceiteError"></div>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn btn-primary" id="btnProximo" disabled>Próximo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Expiração -->
    <div id="expiredModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">O tempo para a compra expirou</div>
            <div class="modal-text">
                Isso é necessário para que uma reserva não fique presa e possa estar disponível para compra novamente.<br><br>
                Você pode recomeçar a compra clicando no botão abaixo.
            </div>
            <button type="button" class="btn btn-primary" onclick="voltarPaginaAnterior()">Voltar</button>
        </div>
    </div>

    <!-- Modal de Data Inválida -->
    <div id="dataInvalidaModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Data Inválida</div>
            <div class="modal-text">
                Por favor, insira uma data de nascimento válida no formato dd/mm/aaaa.
            </div>
            <button type="button" class="btn btn-primary" onclick="fecharModal('dataInvalidaModal')">OK</button>
        </div>
    </div>

    <!-- Modal de Alerta Genérico -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Atenção</div>
            <div class="modal-text" id="alertModalText">
                Mensagem de alerta
            </div>
            <button type="button" class="btn btn-primary" onclick="fecharModal('alertModal')">OK</button>
        </div>
    </div>

    <!-- Modal de Loading CPF -->
    <div id="loadingCpfModal" class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Buscando Dados...</div>
        </div>
    </div>

    <!-- Modal de Loading Pagamento -->
    <div id="loadingPagamentoModal" class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Aguarde, direcionando para área de pagamento...</div>
        </div>
    </div>

    <script>
        // Adicionar no início do script da página
        window.addEventListener('beforeunload', function() {
            // Limpar qualquer token restante ao sair da página
            sessionStorage.removeItem('inscricao_token');
        });

        // Desabilitar F5 e Ctrl+R
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                alert('Atualização da página não permitida. Retorne à página anterior.');
                return false;
            }
        });

        // Variáveis globais
        let timerInterval;
        let tempoRestante = 15 * 60; // 15 minutos em segundos
        let dadosEvento = {};

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            carregarDadosEvento();
            carregarEstados();
            iniciarTimer();
            configurarMascaras();
            configurarEventos();
            // Nova função para inicializar os widgets de valores
            inicializarWidgetsValores();
        });

        // Carregar dados do evento do localStorage
        function carregarDadosEvento() {
            dadosEvento = {
                idevento: localStorage.getItem('idevento'),
                iditem: localStorage.getItem('lote_iditem'),
                descricao: localStorage.getItem('lote_descricao'),
                titulo: localStorage.getItem('titulo_evento'),
                vlinscricao: parseFloat(localStorage.getItem('lote_vlinscricao')) || 0,
                vltaxa: parseFloat(localStorage.getItem('lote_vltaxa')) || 0,
                vltotal: parseFloat(localStorage.getItem('lote_vltotal')) || 0,
                vlinscricao_meia: parseFloat(localStorage.getItem('lote_vlinscricao_meia')) || 0,
                vltaxa_meia: parseFloat(localStorage.getItem('lote_vltaxa_meia')) || 0,
                vltotal_meia: parseFloat(localStorage.getItem('lote_vltotal_meia')) || 0
            };

            // Atualizar interface
            document.getElementById('eventoTitulo').textContent = dadosEvento.titulo || 'Evento não identificado';
            document.getElementById('loteInfo').textContent = dadosEvento.descricao || 'Lote não identificado';
        }

        // Nova função para inicializar os widgets de valores
        function inicializarWidgetsValores() {
            // Atualizar widgets com valores padrão (inteira)
            atualizarWidgetsValores(dadosEvento.vlinscricao, dadosEvento.vltaxa, dadosEvento.vltotal);
            
            // Mostrar os widgets
            const widgetDesktop = document.getElementById('valoresWidgetDesktop');
            const widgetMobile = document.getElementById('valoresWidgetMobile');
            
            // Definir informações do lote
            const loteInfo = dadosEvento.descricao || 'Lote Padrão';
            document.getElementById('widgetLoteDesktop').textContent = loteInfo;
            document.getElementById('widgetLoteMobile').textContent = loteInfo;
            
            // Mostrar widgets baseado no tamanho da tela
            if (window.innerWidth >= 768) {
                widgetDesktop.style.display = 'block';
                widgetMobile.style.display = 'none';
            } else {
                widgetDesktop.style.display = 'none';
                widgetMobile.style.display = 'block';
            }
        }

        // Nova função para atualizar os widgets de valores
        function atualizarWidgetsValores(valorInscricao, valorTaxa, valorTotal) {
            // Formatar valores
            const inscricaoFormatado = `R$ ${valorInscricao.toFixed(2).replace('.', ',')}`;
            const taxaFormatado = `R$ ${valorTaxa.toFixed(2).replace('.', ',')}`;
            const totalFormatado = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
            
            // Atualizar widget desktop
            document.getElementById('widgetValorInscricaoDesktop').textContent = inscricaoFormatado;
            document.getElementById('widgetValorTaxaDesktop').textContent = taxaFormatado;
            document.getElementById('widgetValorTotalDesktop').textContent = totalFormatado;
            
            // Atualizar widget mobile
            document.getElementById('widgetValorInscricaoMobile').textContent = inscricaoFormatado;
            document.getElementById('widgetValorTaxaMobile').textContent = taxaFormatado;
            document.getElementById('widgetValorTotalMobile').textContent = totalFormatado;
        }

        // Timer countdown
        function iniciarTimer() {
            function atualizarTimer() {
                const minutos = Math.floor(tempoRestante / 60);
                const segundos = tempoRestante % 60;
                document.getElementById('timer').textContent = 
                    `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
                
                if (tempoRestante <= 0) {
                    clearInterval(timerInterval);
                    mostrarModal('expiredModal');
                } else {
                    tempoRestante--;
                }
            }
            
            atualizarTimer();
            timerInterval = setInterval(atualizarTimer, 1000);
        }

        // Configurar máscaras
        function configurarMascaras() {
            $('#cpf').mask('000.000.000-00');
            $('#dataNascimento').mask('00/00/0000');
            $('#celular').mask('(00) 00000-0000');
            $('#telEmergencia').mask('(00) 00000-0000');
        }

        // Configurar eventos
        function configurarEventos() {
            // Permitir apenas números nos campos específicos
            ['cpf', 'dataNascimento', 'celular', 'telEmergencia'].forEach(id => {
                document.getElementById(id).addEventListener('input', function(e) {
                    // Remove tudo que não for número
                    let value = e.target.value.replace(/\D/g, '');
                    
                    // Aplica a máscara dependendo do campo
                    if (id === 'cpf') {
                        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    } else if (id === 'dataNascimento') {
                        value = value.replace(/(\d{2})(\d{2})(\d{4})/, '$1/$2/$3');
                    } else if (id === 'celular' || id === 'telEmergencia') {
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    }
                    
                    e.target.value = value;
                });
                
                // Previne entrada de caracteres não numéricos
                document.getElementById(id).addEventListener('keypress', function(e) {
                    if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            });

            // Campos em maiúsculo
            ['nome', 'sobrenome', 'contEmergencia', 'nomepeito', 'cupom'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            });

            // Validação do CPF ao sair do campo - COM MODAL DE LOADING
            $('#cpf').on('blur', function() {
                const cpf = $(this).val().replace(/\D/g, '');
                
                if (cpf.length !== 11) {
                    return;
                }

                // Mostrar modal de loading
                mostrarModal('loadingCpfModal');

                // Primeira chamada para validar o formato do CPF
                fetch(`/validar-cpf?cpf=${cpf}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.valid) {
                            fecharModal('loadingCpfModal');
                            showModal('CPF inválido');
                            $(this).val('');
                            setTimeout(() => {
                                $(this).focus();
                            }, 100);
                            return Promise.reject('CPF inválido');
                        }
                        
                        const idevento = dadosEvento.idevento;
                        return fetch(`/verifica-cpf-inscrito/${idevento}?cpf=${cpf}`);
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            fecharModal('loadingCpfModal');
                            showModal('CPF já inscrito para o evento.');
                            $(this).val('');
                            setTimeout(() => {
                                $(this).focus();
                            }, 100);
                            return Promise.reject('CPF já inscrito');
                        }
                        
                        // Nova verificação: buscar dados existentes do CPF
                        return fetch(`/buscar-dados-cpf?cpf=${cpf}`);
                    })
                    .then(response => response.json())
                    .then(data => {
                        fecharModal('loadingCpfModal');
                        if (data.success) {
                            // Preencher formulário com dados encontrados - SEM MODAL
                            preencherFormularioComDados(data.dados);
                        } else {
                            fecharModal('loadingPagamentoModal'); 
                            alert('Erro ao salvar inscrição: ' + (data.mensagem || 'Erro desconhecido'));
                        }

                        // Se não encontrou dados, não faz nada (formulário continua em branco)
                    })
                    .catch(error => {
                        fecharModal('loadingCpfModal');
                        if (error !== 'CPF inválido' && error !== 'CPF já inscrito') {
                            console.error('Erro na validação do CPF:', error);
                        }
                    });
            });

            // Validação de data
            document.getElementById('dataNascimento').addEventListener('blur', function() {
                if (this.value) {
                    if (validarData(this.value)) {
                        calcularIdadeEValores();
                    } else {
                        mostrarModal('dataInvalidaModal');
                        this.focus();
                    }
                }
            });

            // Estado - MODIFICADO para não usar cidade padrão quando mudado manualmente
            document.getElementById('estado').addEventListener('change', function() {
                carregarCidades(this.value); // Remove o segundo parâmetro
            });           
        
            // Estado
            document.getElementById('estado').addEventListener('change', function() {
                carregarCidades(this.value);
            });

            // Termo de aceite
            document.getElementById('termoAceite').addEventListener('change', function() {
                document.getElementById('btnProximo').disabled = !this.checked;
            });

            // Submit do formulário - COM MODAL DE LOADING
            document.getElementById('inscricaoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (validarFormulario()) {
                    // Mostrar modal de loading do pagamento
                    mostrarModal('loadingPagamentoModal');
                    salvarInscricao();
                }
            });

            // Event listener para redimensionamento da janela
            window.addEventListener('resize', function() {
                const widgetDesktop = document.getElementById('valoresWidgetDesktop');
                const widgetMobile = document.getElementById('valoresWidgetMobile');
                
                if (window.innerWidth >= 768) {
                    widgetDesktop.style.display = 'block';
                    widgetMobile.style.display = 'none';
                } else {
                    widgetDesktop.style.display = 'none';
                    widgetMobile.style.display = 'block';
                }
            });
        }

        // Função para mostrar modal de alerta
        function showModal(mensagem) {
            document.getElementById('alertModalText').textContent = mensagem;
            document.getElementById('alertModal').style.display = 'block';
        }

        // Nova função para preencher formulário com dados existentes
        function preencherFormularioComDados(dados) {
            // Preencher campos básicos
            document.getElementById('nome').value = dados.nome || '';
            document.getElementById('sobrenome').value = dados.sobrenome || '';
            document.getElementById('email').value = dados.email || '';
            
            // Preencher celular com máscara aplicada
            if (dados.celular) {
                // Remove qualquer formatação existente e aplica a máscara
                const celularLimpo = dados.celular.replace(/\D/g, '');
                const celularFormatado = celularLimpo.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                document.getElementById('celular').value = celularFormatado;
            }
            
            // Preencher data de nascimento e disparar evento para calcular valores
            if (dados.dtnascimento) {
                document.getElementById('dataNascimento').value = dados.dtnascimento;
                // Simular evento blur para calcular idade e valores
                const event = new Event('blur', { bubbles: true });
                document.getElementById('dataNascimento').dispatchEvent(event);
            }
            
            // Preencher sexo
            if (dados.sexo) {
                const radioSexo = document.querySelector(`input[name="sexo"][value="${dados.sexo}"]`);
                if (radioSexo) {
                    radioSexo.checked = true;
                }
            }
            
            // Preencher estado e depois cidade
            if (dados.estado) {
                document.getElementById('estado').value = dados.estado;
                
                // Carregar cidades do estado e definir a cidade
                if (dados.id_cidade) {
                    carregarCidades(dados.estado, dados.id_cidade);
                } else {
                    carregarCidades(dados.estado);
                }
            }
        }

        // Carregar estados com valor padrão
        function carregarEstados() {
            fetch('/listar-estados')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('estado');
                        data.estados.forEach(estado => {
                            const option = document.createElement('option');
                            option.value = estado.uf;
                            option.textContent = estado.nome;
                            select.appendChild(option);
                        });
                        
                        // Definir Rondônia como padrão
                        select.value = 'RO';
                        
                        // Carregar cidades de Rondônia e definir Porto Velho como padrão
                        carregarCidades('RO', 7535);
                    }
                })
                .catch(error => console.error('Erro ao carregar estados:', error));
        }

        // Carregar cidades com possibilidade de valor padrão
        function carregarCidades(uf, cidadePadrao = null) {
            const cidadeSelect = document.getElementById('cidade');
            
            if (!uf) {
                cidadeSelect.innerHTML = '<option value="">Primeiro selecione um estado</option>';
                cidadeSelect.disabled = true;
                return;
            }

            cidadeSelect.innerHTML = '<option value="">Carregando...</option>';
            cidadeSelect.disabled = true;

            fetch(`/listar-cidades?uf=${uf}`)
                .then(response => response.json())
                .then(data => {
                    cidadeSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
                    
                    if (data.success) {
                        data.cidades.forEach(cidade => {
                            const option = document.createElement('option');
                            option.value = cidade.id_cidade;
                            option.textContent = cidade.descricao;
                            cidadeSelect.appendChild(option);
                        });
                        cidadeSelect.disabled = false;
                        
                        // Definir cidade padrão se fornecida
                        if (cidadePadrao) {
                            cidadeSelect.value = cidadePadrao;
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar cidades:', error);
                    cidadeSelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
                });
        }


        // // Carregar estados
        // function carregarEstados() {
        //     fetch('/listar-estados')
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.success) {
        //                 const select = document.getElementById('estado');
        //                 data.estados.forEach(estado => {
        //                     const option = document.createElement('option');
        //                     option.value = estado.uf;
        //                     option.textContent = estado.nome;
        //                     select.appendChild(option);
        //                 });
        //             }
        //         })
        //         .catch(error => console.error('Erro ao carregar estados:', error));
        // }

        // // Carregar cidades
        // function carregarCidades(uf) {
        //     const cidadeSelect = document.getElementById('cidade');
            
        //     if (!uf) {
        //         cidadeSelect.innerHTML = '<option value="">Primeiro selecione um estado</option>';
        //         cidadeSelect.disabled = true;
        //         return;
        //     }

        //     cidadeSelect.innerHTML = '<option value="">Carregando...</option>';
        //     cidadeSelect.disabled = true;

        //     fetch(`/listar-cidades?uf=${uf}`)
        //         .then(response => response.json())
        //         .then(data => {
        //             cidadeSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
                    
        //             if (data.success) {
        //                 data.cidades.forEach(cidade => {
        //                     const option = document.createElement('option');
        //                     option.value = cidade.id_cidade;
        //                     option.textContent = cidade.descricao;
        //                     cidadeSelect.appendChild(option);
        //                 });
        //                 cidadeSelect.disabled = false;
        //             }
        //         })
        //         .catch(error => {
        //             console.error('Erro ao carregar cidades:', error);
        //             cidadeSelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
        //         });
        // }

        // Calcular idade e valores - MODIFICADO para atualizar os widgets
        function calcularIdadeEValores() {
            const dataNasc = document.getElementById('dataNascimento').value;
            if (!dataNasc || !validarData(dataNasc)) return;

            const [dia, mes, ano] = dataNasc.split('/');
            const nascimento = new Date(ano, mes - 1, dia);
            
            // Data do evento (pode ser dinâmica)
            const dataEvento = new Date(2026, 0, 18); // 18/01/2026
            
            let idade = dataEvento.getFullYear() - nascimento.getFullYear();
            const diffMes = dataEvento.getMonth() - nascimento.getMonth();
            
            if (diffMes < 0 || (diffMes === 0 && dataEvento.getDate() < nascimento.getDate())) {
                idade--;
            }

            // Definir valores baseado na idade
            let valorInscricao, valorTaxa, valorTotal;
            
            if (idade >= 60) {
                valorInscricao = dadosEvento.vlinscricao_meia;
                valorTaxa = dadosEvento.vltaxa_meia;
                valorTotal = dadosEvento.vltotal_meia;
            } else {
                valorInscricao = dadosEvento.vlinscricao;
                valorTaxa = dadosEvento.vltaxa;
                valorTotal = dadosEvento.vltotal;
            }

            // Atualizar interface original
            document.getElementById('valorInscricao').textContent = `R$ ${valorInscricao.toFixed(2).replace('.', ',')}`;
            document.getElementById('valorTaxa').textContent = `R$ ${valorTaxa.toFixed(2).replace('.', ',')}`;
            document.getElementById('valorTotal').textContent = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
            
            // Atualizar os widgets flutuantes
            atualizarWidgetsValores(valorInscricao, valorTaxa, valorTotal);
            
            // Mostrar container de valores original
            document.getElementById('valoresContainer').style.display = 'block';
        }

        // Validar CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
                mostrarErro('cpfError', 'CPF inválido');
                return false;
            }

            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) {
                mostrarErro('cpfError', 'CPF inválido');
                return false;
            }

            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(10))) {
                mostrarErro('cpfError', 'CPF inválido');
                return false;
            }

            esconderErro('cpfError');
            return true;
        }

        // Validar data
        function validarData(data) {
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = data.match(regex);
            
            if (!match) return false;
            
            const dia = parseInt(match[1]);
            const mes = parseInt(match[2]);
            const ano = parseInt(match[3]);
            
            const dataObj = new Date(ano, mes - 1, dia);
            
            if (dataObj.getDate() !== dia || dataObj.getMonth() !== (mes - 1) || dataObj.getFullYear() !== ano) {
                return false;
            }
            
            const hoje = new Date();
            if (dataObj >= hoje) {
                return false;
            }
            
            return true;
        }

        // Validar email
        function validarEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // Validar formulário
        function validarFormulario() {
            let valido = true;
            
            // Email
            const email = document.getElementById('email').value;
            if (!email || !validarEmail(email)) {
                mostrarErro('emailError', 'E-mail inválido');
                valido = false;
            } else {
                esconderErro('emailError');
            }

            // CPF
            const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
            if (!cpf || !validarCPF(cpf)) {
                valido = false;
            }

            // Nome
            const nome = document.getElementById('nome').value.trim();
            if (!nome) {
                mostrarErro('nomeError', 'Nome é obrigatório');
                valido = false;
            } else {
                esconderErro('nomeError');
            }

            // Sobrenome
            const sobrenome = document.getElementById('sobrenome').value.trim();
            if (!sobrenome) {
                mostrarErro('sobrenomeError', 'Sobrenome é obrigatório');
                valido = false;
            } else {
                esconderErro('sobrenomeError');
            }

            // Data de nascimento
            const dataNasc = document.getElementById('dataNascimento').value;
            if (!dataNasc || !validarData(dataNasc)) {
                mostrarErro('dataNascimentoError', 'Data de nascimento inválida');
                valido = false;
            } else {
                esconderErro('dataNascimentoError');
            }

            // Celular
            const celular = document.getElementById('celular').value.replace(/\D/g, '');
            if (!celular || celular.length !== 11) {
                mostrarErro('celularError', 'Celular inválido');
                valido = false;
            } else {
                esconderErro('celularError');
            }

            // Sexo
            const sexo = document.querySelector('input[name="sexo"]:checked');
            if (!sexo) {
                mostrarErro('sexoError', 'Selecione o sexo');
                valido = false;
            } else {
                esconderErro('sexoError');
            }

            // Camiseta
            const camiseta = document.querySelector('input[name="camiseta"]:checked');
            if (!camiseta) {
                mostrarErro('camisetaError', 'Selecione o tamanho da camiseta');
                valido = false;
            } else {
                esconderErro('camisetaError');
            }

            // Estado
            const estado = document.getElementById('estado').value;
            if (!estado) {
                mostrarErro('estadoError', 'Selecione um estado');
                valido = false;
            } else {
                esconderErro('estadoError');
            }

            // Cidade
            const cidade = document.getElementById('cidade').value;
            if (!cidade) {
                mostrarErro('cidadeError', 'Selecione uma cidade');
                valido = false;
            } else {
                esconderErro('cidadeError');
            }

            // Forma de pagamento
            const formaPagamento = document.querySelector('input[name="formaPagamento"]:checked');
            if (!formaPagamento) {
                mostrarErro('formaPagamentoError', 'Selecione a forma de pagamento');
                valido = false;
            } else {
                esconderErro('formaPagamentoError');
            }

            // Termo de aceite
            const termoAceite = document.getElementById('termoAceite').checked;
            if (!termoAceite) {
                mostrarErro('termoAceiteError', 'Você deve aceitar os termos');
                valido = false;
            } else {
                esconderErro('termoAceiteError');
            }

            return valido;
        }

        // Salvar inscrição (função consolidada)
        function salvarInscricao() {
            // Calcular idade
            const dataNasc = document.getElementById('dataNascimento').value;
            const [dia, mes, ano] = dataNasc.split('/');
            const nascimento = new Date(ano, mes - 1, dia);
            const dataEvento = new Date(2026, 0, 18); // 18/01/2026
            
            let idade = dataEvento.getFullYear() - nascimento.getFullYear();
            const diffMes = dataEvento.getMonth() - nascimento.getMonth();
            
            if (diffMes < 0 || (diffMes === 0 && dataEvento.getDate() < nascimento.getDate())) {
                idade--;
            }

            // Preparar dados para envio
            const dadosInscricao = {
                idevento: dadosEvento.idevento,
                iditemevento: dadosEvento.iditem,
                cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
                email: document.getElementById('email').value.trim(),
                nome: document.getElementById('nome').value.trim(),
                sobrenome: document.getElementById('sobrenome').value.trim(),
                dtnascimento: document.getElementById('dataNascimento').value,
                idade: idade,
                celular: document.getElementById('celular').value.replace(/\D/g, ''),
                sexo: document.querySelector('input[name="sexo"]:checked').value,
                nomepeito: document.getElementById('nomepeito').value.trim().toUpperCase() || null,
                equipe: document.getElementById('equipe').value.trim().toUpperCase() || null,
                camiseta: document.querySelector('input[name="camiseta"]:checked').value,
                tel_emergencia: document.getElementById('telEmergencia').value.replace(/\D/g, '') || null,
                cont_emergencia: document.getElementById('contEmergencia').value.trim().toUpperCase() || null,
                estado: parseInt(document.getElementById('estado').value),
                id_cidade: parseInt(document.getElementById('cidade').value),
                cupom: document.getElementById('cupom').value.trim().toUpperCase() || null,
                formapgto: document.querySelector('input[name="formaPagamento"]:checked').value,
                
                // Valores baseados na idade
                vlinscricao: idade >= 60 ? dadosEvento.vlinscricao_meia : dadosEvento.vlinscricao,
                vltaxa: idade >= 60 ? dadosEvento.vltaxa_meia : dadosEvento.vltaxa,
                vltotal: idade >= 60 ? dadosEvento.vltotal_meia : dadosEvento.vltotal,
                
                status: 'P' // Pendente
            };

            // Enviar dados para o backend
            fetch('/evento_salvar_inscricao', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosInscricao)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Salvar ID da inscrição para próximas etapas
                    localStorage.setItem('inscricao_id', data.inscricao_id);
                    
                    // Redirecionar baseado na forma de pagamento
                    const formaPagamento = document.querySelector('input[name="formaPagamento"]:checked').value;
                    if (formaPagamento === 'PIX') {
                        // Calcular valores finais baseados na idade
                        const vlinscricaoFinal = idade >= 60 ? dadosEvento.vlinscricao_meia : dadosEvento.vlinscricao;
                        const vltaxaFinal = idade >= 60 ? dadosEvento.vltaxa_meia : dadosEvento.vltaxa;
                        const vltotalFinal = idade >= 60 ? dadosEvento.vltotal_meia : dadosEvento.vltotal;
                        
                        // Salvar dados do usuário para a página de pagamento
                        localStorage.setItem('id_evento', dadosInscricao.idevento);
                        localStorage.setItem('user_name', `${dadosInscricao.nome} ${dadosInscricao.sobrenome}`);
                        localStorage.setItem('user_email', dadosInscricao.email);
                        localStorage.setItem('user_cpf', dadosInscricao.cpf);
                        localStorage.setItem('user_idatleta', data.inscricao_id.toString());
                        
                        // Salvar valores financeiros
                        localStorage.setItem('valoratual', vlinscricaoFinal.toFixed(2));
                        localStorage.setItem('valortaxa', vltaxaFinal.toFixed(2));
                        localStorage.setItem('valortotal', vltotalFinal.toFixed(2));
                        
                        // Debug - verificar se os dados foram salvos
                        console.log('Dados salvos no localStorage:');
                        console.log('user_name:', localStorage.getItem('user_name'));
                        console.log('user_email:', localStorage.getItem('user_email'));
                        console.log('valoratual:', localStorage.getItem('valoratual'));
                        console.log('valortaxa:', localStorage.getItem('valortaxa'));
                        console.log('valortotal:', localStorage.getItem('valortotal'));
                        
                        window.location.href = '/pagamento';
                    } else {
                        // Calcular valores finais baseados na idade
                        const vlinscricaoFinal = idade >= 60 ? dadosEvento.vlinscricao_meia : dadosEvento.vlinscricao;
                        const vltaxaFinal = idade >= 60 ? dadosEvento.vltaxa_meia : dadosEvento.vltaxa;
                        const vltotalFinal = idade >= 60 ? dadosEvento.vltotal_meia : dadosEvento.vltotal;

                        // Salvar dados do usuário para a página de pagamento
                        localStorage.setItem('id_evento', dadosInscricao.idevento);
                        localStorage.setItem('user_name', `${dadosInscricao.nome} ${dadosInscricao.sobrenome}`);
                        localStorage.setItem('user_email', dadosInscricao.email);
                        localStorage.setItem('user_cpf', dadosInscricao.cpf);
                        localStorage.setItem('user_idatleta', data.inscricao_id.toString());
                        
                        // Salvar valores financeiros
                        localStorage.setItem('valoratual', vlinscricaoFinal.toFixed(2));
                        localStorage.setItem('valortaxa', vltaxaFinal.toFixed(2));
                        localStorage.setItem('valortotal', vltotalFinal.toFixed(2));
                        
                        // Debug - verificar se os dados foram salvos
                        console.log('Dados salvos no localStorage:');
                        console.log('user_name:', localStorage.getItem('user_name'));
                        console.log('user_cpf:', localStorage.getItem('user_cpf'));
                        console.log('user_email:', localStorage.getItem('user_email'));
                        console.log('valoratual:', localStorage.getItem('valoratual'));
                        console.log('valortaxa:', localStorage.getItem('valortaxa'));
                        console.log('valortotal:', localStorage.getItem('valortotal'));

                        // Validar se todos os campos necessários estão presentes
                        if (!vltotalFinal || !localStorage.getItem('user_name') || !localStorage.getItem('user_cpf') || !localStorage.getItem('user_email')) {
                            console.error('Dados obrigatórios faltando:', {
                                vltotalFinal,
                                userName: localStorage.getItem('user_name'),
                                userCPF: localStorage.getItem('user_cpf'),
                                userEmail: localStorage.getItem('user_email')
                            });
                            alert('Dados incompletos. Por favor, verifique se todos os campos estão preenchidos.');
                            return;
                        }

                        // Preparar dados para enviar ao backend
                        const requestData = {
                            valortotal: vltotalFinal,
                            valortaxa: vltaxaFinal,
                            user_name: localStorage.getItem('user_name'),
                            user_email: localStorage.getItem('user_email'),
                            user_cpf: localStorage.getItem('user_cpf')
                        };
                        localStorage.setItem('valoratual', vlinscricaoFinal.toString());
                        localStorage.setItem('vlinscricao', vlinscricaoFinal.toString());
                        localStorage.setItem('valortotal', vltotalFinal.toString());

                        // localStorage.setItem('valoratual', vlinscricao.toString());
                        // localStorage.setItem('vlinscricao', vlinscricao.toString());
                        // localStorage.setItem('valortotal', valorTotal.toString());

                        console.log('Dados sendo enviados:', requestData);
                        
                        window.location.href = '/checkout';
                    }
                } else {
                    alert('Erro ao salvar inscrição: ' + (data.mensagem || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                fecharModal('loadingPagamentoModal'); 
                console.error('Erro:', error);
                alert('Erro ao processar inscrição. Tente novamente.');
            });
        }

        // Funções de utilidade
        function mostrarErro(elementId, mensagem) {
            const element = document.getElementById(elementId);
            element.textContent = mensagem;
            element.style.display = 'block';
        }

        function esconderErro(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'none';
        }

        function mostrarModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function voltarPaginaAnterior() {
            window.history.back();
        }

        // Cleanup ao sair da página
        window.addEventListener('beforeunload', function() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });

    </script>
</body>
</html>