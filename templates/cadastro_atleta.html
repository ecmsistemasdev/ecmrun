<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/css/cadastro_atleta.css"/>
    <title>Cadastro de Atleta</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script>
        if (window.jQuery) {
            console.log('jQuery carregado com sucesso');
        } else {
            console.error('jQuery não foi carregado');
        }
    </script>    
</head>
<body>
    <div id="cepModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button class="modal-button" onclick="closeModal()">OK</button>
        </div>
    </div>

    <div class="logo-container">
        <img src="https://ecmrun.com.br/static/img/ecmrunlogo1.png" alt="Logo" class="logo">
    </div>
    
    <form id="cadastroForm">
        <div class="form-title">Formulário de Cadastro</div>

        <div class="form-row">
            <div class="form-field">
                <label for="primeiro_nome">Nome:</label>
                <input type="text" id="primeiro_nome" name="primeiro_nome" class="uppercase" required>
            </div>
            <div class="form-field">
                <label for="sobrenome">Sobrenome:</label>
                <input type="text" id="sobrenome" name="sobrenome" class="uppercase" required>
            </div>
        </div>

        <div class="form-group">
            <label>Sexo:</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="sexo" value="M" required> Masculino
                </label>
                <label>
                    <input type="radio" name="sexo" value="F"> Feminino
                </label>
            </div>
        </div>

        <div class="form-row">
            <div class="form-field">
                <label for="cpf">CPF:</label>
                <input type="text" id="cpf" name="cpf" maxlength="14" inputmode="numeric" required>
            </div>
            
            <div class="form-field">
                <label for="data_nascimento">Data de Nascimento:</label>
                <input type="date" id="data_nascimento" name="data_nascimento" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-field">
                <label for="celular">Celular:</label>
                <input type="tel" id="celular" name="celular" required>
            </div>
            <div class="form-field">
                <label for="telefone_emergencia">Telefone de Emergência:</label>
                <input type="tel" id="telefone_emergencia" name="telefone_emergencia">
            </div>
        </div>

        <div class="form-group">
            <label for="contato_emergencia">Nome de Contato de Emergência:</label>
            <input type="text" id="contato_emergencia" name="contato_emergencia" class="uppercase">
        </div>

        <div class="form-row">
            <div class="form-field">
                <label for="estado">Estado:</label>
                <select id="estado" name="estado" required>
                    <option value="" disabled selected>Selecione um estado</option>
                </select>
            </div>
            <div class="form-field">
                <label for="cidade">Cidade:</label>
                <select id="cidade" name="cidade" required disabled>
                    <option value="" disabled selected>Selecione um estado primeiro</option>
                </select>
            </div>
        </div>

        <div class="divider"></div>

        <div class="form-row">
            <div class="form-field">
                <label for="email">E-mail:</label>
                <input type="email" id="email" name="email" required>
            </div>
        </div>

    </form>

    <form id="termoForm">
        <div class="form-title">Termo de Uso</div>
        <div class="termo">
            Declaro que estou me cadastrando neste site por livre e espontânea vontade, com o objetivo de participar em eventos esportivos, adquirir produtos e serviços oferecidos. 
            <br><br>Os dados que informo são verdadeiros e assumo toda responsabilidade acerca dos mesmos, perante a lei. 
            <br><br>Declaro, ainda, reconhecer que os serviços e produtos oferecidos no site possuem uma taxa agregada para cobrir custos, tais como despesas bancárias, serviços do site, conveniência de compra, entre outros. 
            <br><br>Estou ciente que os valores relativos à minha inscrição serão transferidos ao organizador, podendo tal ato ocorrer antes, durante ou depois da realização do evento, sendo certo que na hipótese de cancelamento ou adiamento do mesmo, será de responsabilidade exclusiva do organizador o consequente reembolso, bem como possíveis cominações legais.
            <br><br>Autorizo a utilização de meus dados cadastrais, sabendo que meus dados cadastrais serão respeitados.
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="concordar" name="concordar" required>
                Estou de acordo com o termo acima
            </label>
        </div>

        <button type="button" id="submitBtn" disabled>Continuar</button>
    </form>

    <form id="verificacaoForm" style="display: none;">
        <div class="form-title">Verificação</div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <p>Um código foi enviado para o email: <br>
               <strong><span id="emailMostrado"></span></strong><br>
               Digite o código e cadastre uma senha para finalizar seu cadastro.</p>
        </div>
    
        <div class="form-group">
            <label for="codigoVerificacao">Código de Verificação:</label>
            <input type="text" id="codigoVerificacao" name="codigoVerificacao" 
                   maxlength="4" inputmode="numeric" style="text-align: center; font-size: 24px; letter-spacing: 8px; width: 150px;" required>
        </div>
    
        <div class="form-row">
            <div class="form-field">
                <label for="senha">Senha:</label>
                <input type="password" id="senha" name="senha" required>
            </div>
            <div class="form-field">
                <label for="confirmar_senha">Repetir Senha:</label>
                <input type="password" id="confirmar_senha" name="confirmar_senha" required>
            </div>
        </div>
    
        <div class="button-group">
            <button type="submit" class="active">Confirmar</button>
            <button type="button" id="btnVoltar" class="secondary">Voltar</button>
        </div>
    
        <div class="info-text">
            <p>Para corrigir ou alterar dados do cadastro clique em Voltar.</p>
        </div>
    </form>

    <footer class="footer">
        <img src="/static/img/ecmdev02.png" alt="Logo ECM Run" class="footer-logo">
        <p class="footer-text">ECM Run - 2025, todos os direitos reservados</p>
        <p class="footer-text">Desenvolvido por: ECM Sistemas Developer</p>
    </footer>

    <script>
        $(document).ready(function() {
            // Adicionar este log para verificar se o jQuery está carregando
            console.log('Document ready');
            
            // Opcionalmente, definir a URL base para as requisições
            const BASE_URL = window.location.origin; // Isso pegará a URL base correta tanto em desenvolvimento quanto em produção
            
            // Função helper para fazer requisições
            function makeRequest(endpoint, data) {
                console.log('Fazendo requisição para:', BASE_URL + endpoint);
                return fetch(BASE_URL + endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
            }

            // Máscaras para campos
            $('#cpf').mask('000.000.000-00');
            $('#celular').mask('(00) 00000-0000');
            $('#telefone_emergencia').mask('(00) 00000-0000');

            // Converter para maiúsculo os campos com classe uppercase
            $('.uppercase').on('input', function() {
                $(this).val($(this).val().toUpperCase());
            });

            // Definir data padrão (18 anos atrás)
            function setDefaultDate() {
                const today = new Date();
                const eighteenYearsAgo = new Date(today);
                eighteenYearsAgo.setFullYear(today.getFullYear() - 18);
                
                // Formatar a data no formato YYYY-MM-DD para o campo input type="date"
                const formattedDate = eighteenYearsAgo.toISOString().split('T')[0];
                $('#data_nascimento').val(formattedDate);
            }
            
            // Chamar a função para definir a data padrão quando a página carrega
            setDefaultDate();

            // Função para mostrar modal
            function showModal(message) {
                $('#modalMessage').text(message);
                $('#cepModal').css('display', 'flex');
            }

            // Função para fechar modal
            window.closeModal = function() {
                $('#cepModal').css('display', 'none');
            }

            // Validação do CPF ao sair do campo
            $('#cpf').on('blur', function() {
                const cpf = $(this).val().replace(/\D/g, '');
                
                if (cpf.length !== 11) {
                    return;
                }

                // Primeira chamada para validar o formato do CPF
                fetch(`/validar-cpf?cpf=${cpf}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.valid) {
                            showModal('CPF inválido');
                            $(this).val('');
                            setTimeout(() => {
                                $(this).focus();
                            }, 100);
                            return Promise.reject('CPF inválido');
                        }
                        // Se o CPF for válido, verifica se já existe
                        return fetch(`/verificar-cpf?cpf=${cpf}`);
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            showModal('CPF já cadastrado, caso tenha esquecido a senha, retorne e clique na opção "recuperar senha".');
                            $(this).val('');
                            setTimeout(() => {
                                $(this).focus();
                            }, 100);
                        }
                    })
                    .catch(error => {
                        if (error !== 'CPF inválido') {
                            console.error('Erro na validação do CPF:', error);
                            showModal('Erro ao validar CPF. Tente novamente.');
                        }
                    });
            });

            // Habilitar/desabilitar botão de submit baseado no checkbox
            $('#concordar').on('change', function() {
                if (this.checked) {
                    $('#submitBtn').prop('disabled', false).addClass('active');
                } else {
                    $('#submitBtn').prop('disabled', true).removeClass('active');
                }
            });

            // Carregar estados
            function carregarEstados() {
                fetch('/listar-estados')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const selectEstado = $('#estado');
                            selectEstado.empty().append('<option value="" disabled selected>Selecione um estado</option>');
                            
                            data.estados.forEach(estado => {
                                selectEstado.append(`<option value="${estado.uf}">${estado.nome} (${estado.uf})</option>`);
                            });
                        } else {
                            showModal('Erro ao carregar estados');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar estados:', error);
                        showModal('Erro ao carregar estados. Tente novamente.');
                    });
            }

            // Carregar cidades quando selecionar um estado
            $('#estado').on('change', function() {
                const uf = $(this).val();
                if (!uf) return;
                
                // Adiciona loading spinner
                const cidadeSelect = $('#cidade');
                cidadeSelect.prop('disabled', true);
                cidadeSelect.empty().append('<option value="" disabled selected>Carregando cidades...</option>');
                
                fetch(`/listar-cidades?uf=${uf}`)
                    .then(response => response.json())
                    .then(data => {
                        cidadeSelect.empty();
                        cidadeSelect.append('<option value="" disabled selected>Selecione uma cidade</option>');
                        
                        if (data.success) {
                            data.cidades.forEach(cidade => {
                                cidadeSelect.append(`<option value="${cidade.id_cidade}">${cidade.descricao}</option>`);
                            });
                            cidadeSelect.prop('disabled', false);
                        } else {
                            cidadeSelect.append('<option value="" disabled selected>Erro ao carregar cidades</option>');
                            showModal('Erro ao carregar cidades');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar cidades:', error);
                        cidadeSelect.empty().append('<option value="" disabled selected>Erro ao carregar cidades</option>');
                        showModal('Erro ao carregar cidades. Tente novamente.');
                    });
            });

            // Carregar estados quando a página carregar
            carregarEstados();

            // Máscara para o código de verificação (apenas números)
            $('#codigoVerificacao').on('input', function() {
                this.value = this.value.replace(/\D/g, '');
            });

            // Quando clicar no botão Continuar
            $('#submitBtn').click(function() {
                console.log('Botão Continuar clicado');
                
                // Verificar se os formulários são válidos
                if ($('#cadastroForm')[0].checkValidity() && $('#concordar').is(':checked')) {
                    const emailDigitado = $('#email').val();
                    console.log('Formulário válido, email:', emailDigitado);
                    
                    // Adicionar loading ao botão
                    $(this).prop('disabled', true).html('<div class="loading"></div>');
                    
                    console.log('Iniciando requisição para /enviar-codigo-verificacao');
                    
                    // Enviar requisição para gerar e enviar código
                    fetch('/enviar-codigo-verificacao', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: emailDigitado
                        })
                    })
                    .then(response => {
                        console.log('Resposta recebida:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Dados recebidos:', data);
                        if (data.success) {
                            // Mostrar o email no formulário de verificação
                            $('#emailMostrado').text(emailDigitado);
                            
                            // Ocultar os formulários anteriores
                            $('#cadastroForm, #termoForm').hide();
                            
                            // Mostrar o formulário de verificação
                            $('#verificacaoForm').show();
                        } else {
                            showModal(data.message || 'Erro ao enviar código de verificação');
                        }
                    })
                    .catch(error => {
                        console.error('Erro na requisição:', error);
                        showModal('Erro ao enviar código de verificação. Tente novamente.');
                    })
                    .finally(() => {
                        // Restaurar o botão
                        $('#submitBtn').prop('disabled', false).text('Continuar');
                    });
                } else {
                    console.log('Formulário inválido');
                    showModal('Por favor, preencha todos os campos obrigatórios.');
                }
            });

            // Verificar se o formulário existe
            if ($('#verificacaoForm').length) {
                console.log('Formulário de verificação encontrado');
            } else {
                console.error('Formulário de verificação não encontrado');
            }

            // Atualizar a validação do formulário de verificação
            $('#verificacaoForm').on('submit', function(e) {
                e.preventDefault();
                console.log('Formulário de verificação submetido');
                
                const codigo = $('#codigoVerificacao').val();
                const senha = $('#senha').val();
                const confirmarSenha = $('#confirmar_senha').val();
                
                console.log('Código:', codigo);
                console.log('Dados do formulário:', {
                    codigo: codigo,
                    senha: senha.length, // Não logar a senha real
                    confirmarSenha: confirmarSenha.length // Não logar a senha real
                });

                // Validações básicas
                if (codigo.length !== 4) {
                    showModal('O código deve ter 4 dígitos');
                    return;
                }
                
                if (senha.length < 6) {
                    showModal('A senha deve ter pelo menos 6 caracteres');
                    return;
                }
                
                if (senha !== confirmarSenha) {
                    showModal('As senhas não conferem');
                    return;
                }

                // Desabilita o botão e mostra loading
                const submitButton = $(this).find('button[type="submit"]');
                submitButton.prop('disabled', true).html('<div class="loading"></div>');

                // Primeiro verifica o código
                fetch('/verificar-codigo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        senha: senha,
                        email: $('#email').val()
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Se o código estiver correto, envia os dados do formulário
                        const formData = {
                            primeiro_nome: $('#primeiro_nome').val(),
                            sobrenome: $('#sobrenome').val(),
                            cpf: $('#cpf').val(),
                            data_nascimento: $('#data_nascimento').val(), // Novo campo de data
                            sexo: $('input[name="sexo"]:checked').val(),
                            celular: $('#celular').val(),
                            estado: $('#estado').val(),
                            cidade: $('#cidade').val(),
                            telefone_emergencia: $('#telefone_emergencia').val(),
                            contato_emergencia: $('#contato_emergencia').val(),
                            email: $('#email').val(),
                            senha: senha
                        };

                        return fetch('/salvar-cadastro', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                    } else {
                        throw new Error(data.message || 'Código inválido');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showModal('Cadastro realizado com sucesso!');
                        // Redireciona após o cadastro
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Erro ao salvar cadastro');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showModal(error.message || 'Erro ao processar cadastro. Tente novamente.');
                    // Limpa o campo do código para nova tentativa
                    $('#codigoVerificacao').val('').focus();
                })
                .finally(() => {
                    // Restaura o botão
                    submitButton.prop('disabled', false).text('Confirmar');
                });
            });

            // Adicione também um contador de tentativas
            let tentativas = 0;
            const MAX_TENTATIVAS = 5;

            $('#codigoVerificacao').on('input', function() {
                // Limita a 4 dígitos
                if (this.value.length > 4) {
                    this.value = this.value.slice(0, 4);
                }
                // Remove caracteres não numéricos
                this.value = this.value.replace(/\D/g, '');
            });

            function showLoading(button) {
                button.prop('disabled', true).html('<div class="loading"></div>');
            }

            function hideLoading(button, text) {
                button.prop('disabled', false).text(text);
            }

            // E modifique o botão Confirmar para mostrar feedback visual:
            $('#verificacaoForm button[type="submit"]').on('click', function() {
                console.log('Botão Confirmar clicado');
            });

            // Manipular clique no botão Voltar
            $('#btnVoltar').click(function() {
                // Mostrar os formulários de cadastro e termo
                $('#cadastroForm, #termoForm').show();
                
                // Ocultar o formulário de verificação
                $('#verificacaoForm').hide();
                
                // Limpar os campos do formulário de verificação
                $('#codigoVerificacao, #senha, #confirmar_senha').val('');
            });
        });
    </script>
</body>
</html>
