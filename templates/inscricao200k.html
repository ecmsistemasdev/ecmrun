<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4º Desafio 200k</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 15px;
            background-color: #f0f0f0;
            min-height: 100vh;
        }

        /* Updated header styles */
        .logo-container {
            width: 100%;
            height: 60px;
            background-color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .logo {
            width: 60px;
            height: 60px;
            margin-right: 15px;
        }

        .header-title {
            font-size: 20px;
            color: #333;
            margin: 0;
            text-align: left;
            flex: 1;
        }

        .title-h1 {
            font-size: 20px;
            color: #333;
            margin: 0;
            margin-bottom: 10px;
            text-align: center;
            flex: 1;
        }

        /* Form styles */
        form {
            max-width: 650px;
            background: white;
            padding: 20px;
            border-radius: 7px;
            min-width: 300px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .field-group {
            border-color: #647e99;
            border-radius: 5px;
            border-width: 1px;
            font-size: 14px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 12px;
            padding-top: 3px;
        }

        .form-row {
            display: flex;
            padding-top: 3px;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 12px;
        }
        /* Input styles */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="password"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            height: 36px;
        }

        /* Label styles */
        label {
            display: block;
            margin-bottom: 2px;
            color: #333;
            font-size: 14px;
        }

        .info-label {
            background-color: #f0f0f0;
            padding: 8px;
            border-radius: 4px;
            display: block;
            margin-top: 3px;
            font-size: 14px;
            color: #333;
        }

        .value-label {
            background-color: #e8f4ff;
            padding: 8px;
            border-radius: 4px;
            display: block;
            margin-top: 3px;
            font-size: 14px;
            color: #0056b3;
            font-weight: bold;
        }

        .value-label1 {
            background-color: #e8f4ff;
            padding: 8px;
            border-radius: 4px;
            display: block;
            margin-top: 3px;
            font-size: 14px;
            color: #0056b3;
            font-weight: bold;
        }

        /* Radio group styles */
        .radio-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 14px;
            margin-top: 3px;
        }

        .radio-group label {
            font-size: 14px;
            margin-bottom: 0;
        }

        /* Divider */
        .divider {
            height: 1px;
            background-color: #4376ac;
            margin: 20px 0;
        }

        /* Button styles */
        button {
            background-color: #ccc;
            color: white;
            margin-top: 25px;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: not-allowed;
            font-size: 16px;
            width: auto;
            display: inline-block;
        }

        button.active {
            background-color: #4376ac !important;
            cursor: pointer !important;
        }

        button.active:hover {
            background-color: #3665a0;
        }

        /* Footer styles */
        .footer {
            width: 100%;
            max-width: 650px;
            background-color: white;
            padding: 20px 0;
            margin-top: auto;
            text-align: center;
        }

        .footer-logo {
            height: 60px;
            width: auto;
            margin-bottom: 10px;
        }

        .footer-text {
            font-size: 0.7em;
            color: #333;
            margin: 2px 0;
        }

        /* Media queries */
        @media (max-width: 768px) {
            .logo-container {
                padding: 0 15px;
            }
            
            .header-title .title-h1{
                font-size: 16px;
            }
            
            form {
                width: calc(100% - 0px);
                margin: 0 1px 10px 1px;
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .header-title .title-h1 {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="https://ecmrun.com.br/static/img/ecmrunlogo1.png" alt="Logo" class="logo">
        <h1 class="header-title">4º Desafio 200k - Porto Velho-Humaitá</h1>
    </div>
    <h1 class="title-h1">Formulário de Inscrição</h1>
    <form id="inscricaoForm">    
        <fieldset class="field-group">
            <legend>Dados do Atleta/Inscrição:</legend>
            <div class="form-group">
                <label>Nome Completo:</label>
                <div id="nome_completo" class="info-label"></div>
            </div>
    
            <div class="form-group">
                <label>CPF:</label>
                <div id="cpf" class="info-label"></div>
            </div>

            <div>
                <div class="form-group">
                    <label>Celular:</label>
                    <div id="celular" class="info-label"></div>
                </div>

                <div class="form-group">
                    <label>Data Nascimento:</label>
                    <div id="dtnascimento" class="info-label"></div>
                </div>
            </div>

            <div class="form-group">
                <label>E-mail:</label>
                <div id="email" class="info-label"></div>
            </div>
    
            <div class="form-group">
                <label>Categoria Selecionada:</label>
                <div id="categoria" class="value-label"></div>
            </div>

        </fieldset>
    
        <div class="form-group">
            <label>Camiseta:</label>
            <div class="radio-group">
                <label><input type="radio" name="camiseta" value="PP"> PP</label>
                <label><input type="radio" name="camiseta" value="P"> P</label>
                <label><input type="radio" name="camiseta" value="M"> M</label>
                <label><input type="radio" name="camiseta" value="G"> G</label>
                <label><input type="radio" name="camiseta" value="GG"> GG</label>
            </div>
        </div>

        <div class="form-group">
            <label for="equipe">Equipe/Grupo/Academia:</label>
            <input type="text" id="equipe" name="equipe" placeholder="">
        </div>

        <div class="form-group">
            <label for="apoio">Nome do Apoio (se tiver):</label>
            <input type="text" id="apoio" name="apoio" placeholder="">
        </div>

        <div class="form-group">
            <label for="nome_equipe">Nome da Equipe 200k:</label>
            <input type="text" id="nome_equipe" name="nome_equipe" placeholder="Somente em caso de categoria em Equipe">
        </div>

        <div class="form-group">
            <label for="integrantes">Integrantes:</label>
            <input type="text" id="integrantes" name="integrantes" placeholder="Em caso de Equipe informe os nomes dos integrantes">
        </div>    

        <div class="divider"></div>

        <form id="inscricaoForm">
            <!-- Previous form content remains the same until payment section -->
                
            <div class="form-group">
                <label>Termo de Responsabilidade:</label>
                <div style="height: 200px; overflow-y: auto; font-size: 13px; text-align: justify; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background-color: #f9f9f9;">
                    <div id="termoContent">
                        Eu, *NameCompleto*, declaro que estou ciente e concordo com os termos e condições estabelecidos no Regulamento para a participação neste Desafio, a ser realizada nos dias 04, 05 e 06/07/2025 em Porto Velho/RO.<br><br>
                        1. Declaração de Saúde <br><br>
                        Declaro que estou em plenas condições de saúde para participar deste evento e que não possuo restrições médicas que impeçam minha participação. Estou ciente de que é recomendável realizar uma avaliação médica antes de participar de atividades físicas.<br><br>
                        2. Responsabilidade Pessoal<br><br>
                        Entendo que a participação na corrida envolve riscos, incluindo, mas não se limitando a, lesões físicas, acidentes e outras eventualidades. Ao me inscrever, assumo total responsabilidade por minha participação e isento os organizadores, patrocinadores e colaboradores de qualquer responsabilidade por danos ou lesões que possam ocorrer antes, durante ou após o evento.<br><br>
                        3. Uso de Imagem<br><br>
                        Autorizo a utilização da minha imagem em fotografias e filmagens realizadas durante o evento para fins promocionais e publicitários, sem qualquer ônus para os organizadores.<br><br>
                        4. Cancelamento e Reembolso<br><br>            
                        Em caso de desistência o reembolso em até 7 dias corridos será o valor pago deduzido das taxas, sendo até 30 dias antes da prova, o valor do reembolso será de 50% do valor da inscrição. Restando menos de 30 dias não heverá reembolso. Em casos de cancelamento do evento por parte dos organizadores o reembolso será de 100% do valor pago.<br><br>
                        5. Aceitação dos Termos<br><br>    
                        Ao finalizar minha inscrição, confirmo que li, entendi e concordo com todos os termos deste documento.
        
                    </div>
                </div>
                
                <div style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="aceitoTermos" name="aceitoTermos" required>
                        <span>Confirmo que li e aceito o Termo de Responsabilidade</span>
                    </label>
                </div>
            </div>
            
            <div class="divider"></div>

            <div class="form-group">
                <label>Forma de pagamento:</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="pagamento" value="pix" required> PIX (Desc. 5% no valor da inscrição)
                    </label>
                    <label>
                        <input type="radio" name="pagamento" value="cartao"> Cartão de Crédito
                    </label>
                    <div class="radio-group">
                        <!--<label>Valor da Atualizado:</label>-->
                        <div id="valorAtualizado" class="value-label1"></div>
                        <label class="label-info60" id="campoDesconto" style="display:none;">
                            Atletas com idade 60+ paga 50% do valor da inscrição, conforme Lei nº 10.741/2003</label>
                    </div>
                </div>
            </div>

            <button type="submit" id="submitButton" disabled>Seguir pra Pagamento</button>

            <!--Início do selo -->
            <div class="cartoes" align="center">      
                <!--Selo do Mercado--->
                <div>
                    <img src="https://ecmrun.com.br/static/img/seloseguro.png" style="width:70%; margin-top: 10px;">
                </div>
            </div>
            <!--Final do selo -->

        </form>        

    </form>

    <footer class="footer">
        <img src="/static/img/ecmdev02.png" alt="Logo ECM Run" class="footer-logo">
        <p class="footer-text">ECM Run - 2025, todos os direitos reservados</p>
        <p class="footer-text">Desenvolvido por: ECM Sistemas Developer</p>
    </footer>

    <script>
     
        $(document).ready(function() {
            // Get user data from localStorage
            const userName = localStorage.getItem('user_name');
            const userEmail = localStorage.getItem('user_email');
            const cpf = localStorage.getItem('user_cpf');
            const dataNascimento = localStorage.getItem('user_dtnascimento');
            const idade = parseInt(localStorage.getItem('user_idade')) || 0;
            const celular = localStorage.getItem('user_celular');
            const sexo = localStorage.getItem('user_sexo');
            const idatleta = localStorage.getItem('user_idatleta');
            const categoria = localStorage.getItem('categoria');
            const valor = localStorage.getItem('valor');
            const valorinsc = parseFloat(localStorage.getItem('cat_vlinscricao')) || 0;
            const taxa = parseFloat(localStorage.getItem('cat_vltaxa')) || 0;
            const categoriaId = localStorage.getItem('categoria_id');
            const dataEvento = localStorage.getItem('user_dataevento');
            
            console.info('Valor Original:',valorinsc);

            // Calculate the actual value based on age and format display
            const calculateValues = () => {
                // Determine valoratual based on age
                const valoratual = idade >= 60 ? valorinsc / 2 : valorinsc;
                console.info('Valor Atual:',valoratual);
                const vltaxa = idade >= 60 ? taxa / 2 : taxa;

                // Calculate total value including taxa
                const valortotal = valoratual + vltaxa;

                // Store the calculated values in localStorage
                localStorage.setItem('valoratual', valoratual.toString());
                localStorage.setItem('valortaxa', vltaxa.toString()); // Mudado de 'valortotal' para 'valortaxa'
                localStorage.setItem('valortotal', valortotal.toString());

                console.info('Valor Total:',valortotal);

                // Format the display string with all values
                const displayValue = `${formatCurrency(valoratual)} + ${formatCurrency(vltaxa)} = Total: ${formatCurrency(valortotal)}`;
                console.info('Valor Display:',displayValue);

                // Update the display
                $('#valor').text(displayValue);

                return valortotal;
            };

            if (idade >= 60) {
                campoDesconto.style.display = "block"; // Exibe o campo
            } else {
                campoDesconto.style.display = "none"; // Oculta o campo
            }            

            // Function to format currency values
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            // Function to handle team fields visibility
            const handleTeamFields = (categoriaId) => {
                const camisetaField = document.getElementById('camiseta');
                const equipeField = document.getElementById('equipe');
                const apoioField = document.getElementById('apoio');
                const nomeEquipeField = document.getElementById('nome_equipe');
                const integrantesField = document.getElementById('integrantes');

                if (categoriaId === '1' || categoriaId === 1) {
                    if (nomeEquipeField && integrantesField) {
                        nomeEquipeField.disabled = true;
                        integrantesField.disabled = true;
                        nomeEquipeField.value = '';
                        integrantesField.value = '';
                        nomeEquipeField.style.backgroundColor = '#f0f0f0';
                        integrantesField.style.backgroundColor = '#f0f0f0';
                        nomeEquipeField.placeholder = 'Não aplicável para categoria Solo';
                        integrantesField.placeholder = 'Não aplicável para categoria Solo';
                    }
                } else {
                    if (nomeEquipeField && integrantesField) {
                        nomeEquipeField.disabled = false;
                        integrantesField.disabled = false;
                        nomeEquipeField.style.backgroundColor = '';
                        integrantesField.style.backgroundColor = '';
                        nomeEquipeField.placeholder = 'Se possível, dê um nome a sua Equipe para o Desafio';
                        integrantesField.placeholder = 'Se possível, informe os nomes dos integrantes';
                    }
                }
            };

            // Calculate and store values when page loads
            const totalValue = calculateValues();
            //const valortaxa = parseFloat(localStorage.getItem('valortaxa')) || 0;
            
            console.log('Idade:', idade);
            console.log('Valor Original:', valorinsc);


           // Habilitar/desabilitar botão de submit baseado no checkbox
            $('#aceitoTermos').on('change', function() {
                if (this.checked) {
                    $('#submitButton').prop('disabled', false).addClass('active');
                } else {
                    $('#submitButton').prop('disabled', true).removeClass('active');
                }
            });
            
            $('input[name="pagamento"]').on('change', function() {
                let vlinsc = parseFloat(localStorage.getItem('valoratual')) || 0;
                let tx = parseFloat(localStorage.getItem('valortaxa')) || 0;
                let vl_total;

                if (this.value === 'pix') {
                    let percDesconto = 5;
                    let vlDesconto = vlinsc * (percDesconto / 100);
                    const vl_comdesconto = vlinsc - vlDesconto;
                    vl_total = vl_comdesconto + tx;

                    //localStorage.setItem('valoratual', vlinscricao.toString());
                    //localStorage.setItem('vlinscricao', vlinscricao.toString());
                    //localStorage.setItem('valortotal', vl_total.toString());

                    const displayValueA = `Valor: ${formatCurrency(vl_comdesconto)} + ${formatCurrency(tx)} = Total a pagar: ${formatCurrency(vl_total)}`;
                    console.info('Valor Display atualizado:', displayValueA);

                    // Atualiza a exibição
                    $('#valorAtualizado').text(displayValueA);
                } else {
                    vl_total = vlinsc + tx;

                    //localStorage.setItem('valoratual', vlinscricao.toString());
                    //localStorage.setItem('vlinscricao', vlinscricao.toString());
                    //localStorage.setItem('valortotal', vl_total.toString());

                    const displayValueA = `Valor: ${formatCurrency(vlinsc)} + ${formatCurrency(tx)} = Total a pagar: ${formatCurrency(vl_total)}`;
                    console.info('Valor Display atualizado:', displayValueA);

                    // Atualiza a exibição
                    $('#valorAtualizado').text(displayValueA);
                }
            });

        
            // Form submission handler
            $('#inscricaoForm').on('submit', function(e) {
                e.preventDefault();
                

                sessionStorage.removeItem('paymentData');
                localStorage.removeItem('lastPaymentId');

                const paymentMethod = $('input[name="pagamento"]:checked').val();
                localStorage.setItem('payment_method', paymentMethod);
                
                // Obter valores do localStorage com validação
                const valorTotal = parseFloat(localStorage.getItem('valortotal')) || 0;
                const valorTaxa = parseFloat(localStorage.getItem('valortaxa')) || 0;
                const vlinscricao = parseFloat(localStorage.getItem('valoratual')) || 0;
                
                // Obter outros campos do formulário
                const camiseta = $('input[name="camiseta"]:checked').val();
                const equipe = $('#equipe').val();
                const apoio = $('#apoio').val();
                const nomeEquipe = $('#nome_equipe').val();
                const integrantes = $('#integrantes').val();
                
                // Armazenar valores no localStorage
                localStorage.setItem('camiseta', camiseta);
                localStorage.setItem('apoio', apoio);
                localStorage.setItem('equipe', equipe);
                localStorage.setItem('nome_equipe', nomeEquipe);
                localStorage.setItem('integrantes', integrantes);
                localStorage.setItem('vltaxa', valorTaxa);
                
                if (paymentMethod === 'cartao') {
                    // Log dos valores antes de enviar
                    console.log('Dados sendo enviados para /criar_preferencia:', {
                        valortotal: valorTotal,
                        valortaxa: valorTaxa,
                        user_name: localStorage.getItem('user_name'),
                        user_cpf: localStorage.getItem('user_cpf'),
                        user_email: localStorage.getItem('user_email'),
                        user_idatleta: localStorage.getItem('user_idatleta')
                    });

                    // Validar se todos os campos necessários estão presentes
                    if (!valorTotal || !localStorage.getItem('user_name') || !localStorage.getItem('user_cpf') || !localStorage.getItem('user_email')) {
                        console.error('Dados obrigatórios faltando:', {
                            valorTotal,
                            userName: localStorage.getItem('user_name'),
                            userCPF: localStorage.getItem('user_cpf'),
                            userEmail: localStorage.getItem('user_email')
                        });
                        alert('Dados incompletos. Por favor, verifique se todos os campos estão preenchidos.');
                        return;
                    }

                    // Preparar dados para enviar ao backend
                    const requestData = {
                        valortotal: valorTotal,
                        valortaxa: valorTaxa,
                        user_name: localStorage.getItem('user_name'),
                        user_email: localStorage.getItem('user_email'),
                        user_cpf: localStorage.getItem('user_cpf'),
                        user_idatleta: localStorage.getItem('user_idatleta')
                    };
                    localStorage.setItem('valoratual', vlinscricao.toString());
                    localStorage.setItem('vlinscricao', vlinscricao.toString());
                    localStorage.setItem('valortotal', valorTotal.toString());

                    console.log('Dados sendo enviados:', requestData);
                    
                    window.location.href = '/checkout';

                } else if (paymentMethod === 'pix') {
                    // Código existente para PIX...
                    let percentualDesconto = 5;
                    let valorDesconto = vlinscricao * (percentualDesconto / 100);
                    const taxaatual = parseFloat(localStorage.getItem('valortaxa')) || 0;
                    
                    const valor_comdesconto = vlinscricao - valorDesconto;
                    const valor_total = valor_comdesconto + taxaatual;
                    
                    localStorage.setItem('valoratual', vlinscricao.toString());
                    localStorage.setItem('vlinscricao', vlinscricao.toString());
                    //localStorage.setItem('vldesconto', valorDesconto.toString());
                    localStorage.setItem('valortotal', valor_total.toString());
                
                    
                    window.location.href = '/pagamento';
                }
                
                sessionStorage.removeItem('currentPaymentId');
            });

            // Handle terms acceptance and submit button
            $('#aceitoTermos').on('change', function() {
                $('#submitButton').prop('disabled', !$(this).is(':checked'));
            });

            // Update terms content with user name
            if (userName) {
                const termoContent = document.getElementById('termoContent');
                if (termoContent) {
                    let termoText = termoContent.innerHTML;
                    termoText = termoText.replace('*NameCompleto*', userName);
                    termoContent.innerHTML = termoText;
                }
            }

            // Fill in user information
            if (userName && userEmail) {
                $('#nome_completo').text(userName);
                $('#email').text(userEmail);
                $('#cpf').text(cpf);
                $('#dtnascimento').text(dataNascimento);
                $('#celular').text(celular);
                $('#categoria').text(categoria || 'Não selecionada');
                //$('#valor').text(valor || 'A definir');

                // Handle team fields based on category
                handleTeamFields(categoriaId);
            } else {
                // Redirect to login if no user data
                window.location.href = '/login';
            }

            // Initial state of submit button
            $('#submitButton').prop('disabled', true);
            $('#aceitoTermos').prop('checked', false);
        });

    </script>
</body>
</html>